<!doctype html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>รายการใบเสร็จ</title>
    <style>
    /* existing styles... */
    body {
        font-family: 'Sarabun', Arial, Helvetica, sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f5;
    }

    .page-header {
        background: #fff;
        padding: 16px 24px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        position: relative;
    }

    #logoutBtn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
        border-radius: 4px;
        position: absolute;
        top: 16px;
        left: 24px;
    }

    #logoutBtn:hover {
        background: #c82333;
    }

    h1 {
        margin: 0 0 0 120px;
        font-size: 24px;
        color: #333;
    }

    .panel {
        background: #fff;
        margin: 0 24px 24px 24px;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }

    .header-section h2 {
        margin: 0;
        font-size: 20px;
        color: #495057;
    }

    .top-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .search-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }

    .search-row {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .search-field {
        display: flex;
        flex-direction: column;
    }

    .search-field label {
        font-size: 13px;
        color: #495057;
        margin-bottom: 4px;
        font-weight: 500;
    }

    .search-field input[type="text"],
    .search-field input[type="date"],
    .search-field select {
        padding: 8px 12px;
        font-size: 14px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        min-width: 200px;
    }

    .search-field input[type="text"]:focus,
    .search-field input[type="date"]:focus,
    .search-field select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .search-field.small {
        min-width: 120px;
    }

    .search-field.small select,
    .search-field.small input {
        min-width: 100px;
    }

    button {
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        border-radius: 6px;
        border: 1px solid transparent;
        transition: all 0.2s;
    }

    button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    #btnSearch {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 20px;
    }

    #btnSearch:hover {
        background: #0056b3;
    }

    #btnTodayReport {
        background: #17a2b8;
        color: white;
        border: none;
        font-size: 14px;
        padding: 8px 16px;
    }

    #btnTodayReport:hover {
        background: #138496;
    }

    #btnTodayPdf {
        background: #6f42c1;
        color: white;
        border: none;
        font-size: 14px;
        padding: 8px 16px;
    }

    #btnTodayPdf:hover {
        background: #5a32a3;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 15px;
        background: #fff;
        font-size: 13px;
    }

    th,
    td {
        border: 1px solid #dee2e6;
        padding: 8px 10px;
        text-align: center;
    }

    th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
        white-space: nowrap;
    }

    tbody tr:hover {
        background: #f8f9fa;
    }

    .detail-btn {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 4px;
        cursor: pointer;
        white-space: nowrap;
    }

    .detail-btn:hover {
        background: #138496;
    }

    .status-active {
        display: inline-block;
        background: linear-gradient(180deg, #28a745, #1e7e34);
        color: #fff;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 13px;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06) inset;
    }

    .status-cancelled {
        color: #dc3545;
        font-weight: bold;
    }

    .summary {
        font-size: 13px;
        color: #6c757d;
        margin-top: 10px;
    }

    .pager {
        margin-top: 15px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .pager button {
        padding: 8px 16px;
        font-size: 14px;
    }

    .pager span {
        font-size: 14px;
        color: #495057;
    }

    #detailModal {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    #detailModal .box {
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        max-width: 1400px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    #detailModal h3 {
        margin: 0 0 16px 0;
        color: #212529;
    }

    #detailModal button {
        margin-right: 8px;
    }

    .detail-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .detail-left {
        flex: 1;
        min-width: 0;
    }

    /* make right column wider so buttons don't crowd */
    .detail-right {
        flex: 1.4;
        min-width: 0;
        border-left: 2px solid #dee2e6;
        padding-left: 20px;
    }

    .detail-content {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-top: 12px;
    }

    .detail-section {
        margin-bottom: 20px;
    }

    .detail-section h4 {
        margin: 0 0 10px 0;
        color: #495057;
        font-size: 16px;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 5px;
    }

    .detail-row {
        display: flex;
        margin-bottom: 8px;
    }

    .detail-label {
        font-weight: 600;
        min-width: 180px;
        color: #495057;
    }

    .detail-value {
        color: #212529;
        flex: 1;
        word-wrap: break-word;
    }

    .items-list {
        max-height: 500px;
        overflow-y: auto;
    }

    .item-card {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 10px 12px;
        margin-bottom: 8px;
        transition: all 0.3s ease;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        min-height: auto;
    }

    .item-card:hover {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .item-card.redeemed {
        background: #f5f5f5;
        border-color: #adb5bd;
        opacity: 0.8;
    }

    .item-header {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 0 0 auto;
    }

    .item-name {
        font-weight: 600;
        color: #212529;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
    }

    .item-card.redeemed .item-name {
        color: #6c757d;
    }

    .item-code {
        font-size: 12px;
        color: #6c757d;
        white-space: nowrap;
        flex: 0 0 auto;
    }

    .item-price {
        color: #28a745;
        font-weight: 600;
        font-size: 13px;
        white-space: nowrap;
        flex: 0 0 auto;
        margin-left: auto;
    }

    .item-card.redeemed .item-price {
        color: #6c757d;
    }

    .item-info {
        display: none;
    }

    .item-codes {
        display: none;
    }

    .item-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        flex: 0 0 auto;
    }

    .item-actions label {
        font-size: 12px;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
        margin: 0;
    }

    .item-btn {
        padding: 5px 10px;
        font-size: 11px;
        border-radius: 4px;
        cursor: pointer;
        border: none;
        white-space: nowrap;
        flex: 0 0 auto;
    }

    .btn-view {
        background: #17a2b8;
        color: white;
    }

    .btn-view:hover {
        background: #138496;
    }

    .btn-redeem {
        background: #28a745;
        color: white;
    }

    .btn-redeem:hover {
        background: #218838;
    }

    .btn-redeem:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }

    .btn-cancel-redeem {
        background: #dc3545;
        color: white;
    }

    .btn-cancel-redeem:hover {
        background: #c82333;
    }
        .redeemed-badge {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
            flex: 0 0 auto;
        }

        /* เพิ่มส่วนนี้ */
        .redeemed-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 0 0 auto;
        }

        .redeemed-date {
            font-size: 9px;
            color: #6c757d;
            font-style: italic;
            white-space: nowrap;
        }

    .btn-cancel-redeem:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }

    .redeemed-badge {
        display: inline-block;
        background: #6c757d;
        color: white;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        white-space: nowrap;
        flex: 0 0 auto;
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
        .item-card {
            gap: 6px;
        }

        .item-name {
            max-width: 150px;
        }

        .item-actions {
            flex: 1 1 100%;
            justify-content: flex-start;
            margin-top: 4px;
        }

        .item-price {
            margin-left: 0;
            order: -1;
        }
    }

    @media (max-width: 768px) {
        .item-card {
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
        }

        .item-header {
            width: 100%;
        }

        .item-name {
            max-width: none;
            flex: 1;
        }

        .item-code,
        .item-price {
            margin-left: 0;
        }

        .item-actions {
            width: 100%;
            justify-content: space-between;
        }

        .item-btn {
            flex: 1 1 auto;
            text-align: center;
        }

        .redeemed-badge {
            width: 100%;
            text-align: center;
        }
    }

    @media (max-width: 768px) {
        .detail-container {
            flex-direction: column;
        }

        .detail-right {
            border-left: none;
            border-top: 2px solid #dee2e6;
            padding-left: 0;
            padding-top: 20px;
        }
    }

    /* Coupon Detail Modal */
    #couponModal {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
        z-index: 1001;
    }

    #couponModal .box {
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    #couponModal h3 {
        margin: 0 0 16px 0;
        color: #212529;
    }

    .coupon-detail-content {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
    }

    .coupon-detail-section {
        margin-bottom: 20px;
    }

    .coupon-detail-section:last-child {
        margin-bottom: 0;
    }

    .coupon-detail-section h4 {
        margin: 0 0 10px 0;
        color: #495057;
        font-size: 16px;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 5px;
    }

    .coupon-detail-row {
        display: flex;
        margin-bottom: 8px;
    }

    .coupon-detail-label {
        font-weight: 600;
        min-width: 140px;
        color: #495057;
    }

    .coupon-detail-value {
        color: #212529;
        flex: 1;
        word-wrap: break-word;
    }

    .coupon-price {
        font-size: 20px;
        font-weight: bold;
        color: #28a745;
    }

    .coupon-description {
        background: #fff;
        padding: 12px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        margin-top: 8px;
        white-space: pre-wrap;
        line-height: 1.6;
    }

    .items-table {
        width: 100%;
        font-size: 13px;
        margin-top: 10px;
    }

    .items-table th {
        background: #e9ecef;
    }

    #error {
        color: #dc3545;
        margin-top: 12px;
        padding: 10px;
        background: #f8d7da;
        border-radius: 4px;
        display: none;
    }

    #error:not(:empty) {
        display: block;
    }

    /* จัดกรองคอลัมน์ตาราง */
    .col-code {
        width: 120px;
    }

    .col-date {
        width: 140px;
    }

    .col-customer {
        width: 150px;
    }

    .col-phone {
        width: 120px;
    }

    .col-sales {
        width: 120px;
    }

    .col-payment {
        width: 100px;
    }

    .col-discount {
        width: 100px;
    }

    .col-total {
        width: 100px;
    }

    .col-status {
        width: 80px;
    }

    .col-detail {
        width: 100px;
        text-align: center;
    }

    .col-unredeemed {
        width: 140px;
        text-align: center;
    }

    .cancelled-row {
        background: #ffe6e6 !important;
    }

    /* Confirm Dialog */
    #confirmModal {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        align-items: center;
        justify-content: center;
        z-index: 1002;
    }

    #confirmModal .box {
        background: #fff;
        padding: 30px;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    #confirmModal h3 {
        margin: 0 0 16px 0;
        color: #212529;
        font-size: 20px;
    }

    #confirmModal .confirm-message {
        margin-bottom: 20px;
        color: #495057;
        font-size: 15px;
        line-height: 1.6;
    }

    #confirmModal .confirm-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    #confirmModal .confirm-actions button {
        min-width: 100px;
    }

    .btn-confirm {
        background: #28a745;
        color: white;
        border: none;
    }

    .btn-confirm:hover {
        background: #218838;
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
        border: none;
    }

    .btn-cancel:hover {
        background: #5a6268;
    }

    .coupon-code-highlight {
        background: #fff3cd;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: bold;
        color: #856404;
    }

    .unredeemed-text {
        font-size: 13px;
        color: #495057;
        display: inline-block;
    }

    /* Bulk controls */
    .bulk-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
        flex-wrap: wrap; /* allow wrapping on narrow screens */
    }

    .bulk-controls input[type="text"] {
        padding: 6px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        min-width: 220px;
        flex: 1 1 220px;
    }

    .bulk-controls button {
        padding: 6px 10px;
        font-size: 13px;
        border-radius: 4px;
        min-width: 120px;
        flex: 0 0 auto;
    }

    @media (max-width: 1000px) {
        /* When modal narrows, ensure bulk controls wrap and take full width */
        .detail-right { padding-left: 12px; }
        .bulk-controls input[type="text"] { flex-basis: 100%; }
        .bulk-controls button { flex-basis: 48%; }
    }

    /* Export Date Range Modal (fixed overlay, hidden by default) */
    #exportModal {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
        z-index: 1003;
    }

    #exportModal .box {
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    #exportModal .actions {
        margin-top: 12px;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }

    .btn-export {
        background: #007bff;
        color: #fff;
        border: none;
        padding: 8px 14px;
        border-radius: 6px;
    }

    .btn-export:hover { background: #0056b3; }
    </style>
</head>

<body>
    <div class="page-header">
        <button id="logoutBtn">🚪 Logout</button>
        <h1>📋 รายการใบเสร็จ</h1>
    </div>

    <div class="panel">
        <div class="header-section">
            <h2>รายการใบเสร็จทั้งหมด</h2>
            <div class="top-actions">
                <button id="btnTodayReport">📊 รายงาน Excel</button>
                <button id="btnTodayPdf"
                    style="background:#6f42c1; color:white; border:none; font-size:14px; padding:8px 16px;">📄 รายงาน PDF</button>
            </div>
        </div>

        <div class="search-section">
            <div class="search-row">
                <div class="search-field">
                    <label>รหัสใบเสร็จ:</label>
                    <input id="searchReceiptCode" type="text" placeholder="ค้นหารหัสใบเสร็จ" />
                </div>

                <div class="search-field">
                    <label>รหัสคูปอง:</label>
                    <input id="searchCouponCode" type="text" placeholder="ค้นหารหัสคูปอง" />
                </div>

                <div class="search-field">
                    <label>ชื่อลูกค้า:</label>
                    <input id="searchCustomerName" type="text" placeholder="ค้นหาชื่อลูกค้า" />
                </div>

                <div class="search-field">
                    <label>เบอร์โทร:</label>
                    <input id="searchPhone" type="text" placeholder="ค้นหาเบอร์โทร" />
                </div>

                <div class="search-field small">
                    <label>สถานะ:</label>
                    <select id="searchStatus">
                        <option value="">-- ทั้งหมด --</option>
                        <option value="Active">ใช้งาน</option>
                        <option value="Cancelled">ยกเลิก</option>
                    </select>
                </div>

                <div class="search-field small">
                    <label>วันที่ (จาก):</label>
                    <input id="dateFrom" type="date" />
                </div>

                <div class="search-field small">
                    <label>วันที่ (ถึง):</label>
                    <input id="dateTo" type="date" />
                </div>

                <div class="search-field small">
                    <label>แสดงต่อหน้า:</label>
                    <select id="pageSize">
                        <option>10</option>
                        <option selected>25</option>
                        <option>50</option>
                        <option>100</option>
                    </select>
                </div>

                <div class="search-field"
                    style="justify-content:flex-end; padding-top:20px; display:flex; align-items:center; gap:10px;">
                    <button id="btnSearch">🔍 ค้นหา</button>
                    <button id="btnClearDate">🔄 ล้างวันที่</button>
                </div>
            </div>
        </div>

        <div id="summary" class="summary">-</div>

        <div style="overflow-x:auto">
            <table id="results">
                <thead>
                    <tr>
                        <th class="col-code">รหัสใบเสร็จ</th>
                        <th class="col-date">วันที่</th>
                        <th class="col-customer">ชื่อลูกค้า</th>
                        <th class="col-phone">เบอร์โทร</th>
                        <th class="col-sales">เซลล์</th>
                        <th class="col-payment">การชำระ</th>
                        <th class="col-discount">ส่วนลด</th>
                        <th class="col-total">ยอดรวม</th>
                        <th class="col-status">สถานะ</th>
                        <th class="col-unredeemed">สถานะคูปอง</th>
                        <th class="col-detail">รายละเอียด</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="pager">
            <button id="prev">⬅️ ย้อนกลับ</button>
            <span id="pageInfo"></span>
            <button id="next">ถัดไป ➡️</button>
        </div>

        <div id="error"></div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal">
        <div class="box">
            <h3>📋 รายละเอียดใบเสร็จ</h3>

            <!-- 2 Column Layout -->
            <div class="detail-container">
                <!-- Left Column: Receipt Info -->
                <div class="detail-left">
                    <div id="detailContent" class="detail-content"></div>
                </div>

                <!-- Right Column: Items List -->
                <div class="detail-right">
                    <h4 style="margin-top:0; color:#495057; border-bottom:2px solid #dee2e6; padding-bottom:5px;">รายการสินค้า
                    </h4>

                    <!-- Bulk controls: search and bulk actions -->
                    <div class="bulk-controls">
                        <input id="searchGeneratedCodes" type="text" placeholder="ค้นหารหัสภายในรายการ (เช่น ERB072)" />
                        <button id="bulkRedeemBtn" style="background:#28a745; color:white;" disabled>✂️ ตัดคูปองที่เลือก</button>
                    </div>

                    <div id="itemsList" class="items-list"></div>
                </div>
            </div>

            <div style="margin-top:16px; text-align:right; clear:both;">
                <button id="detailClose" style="background:#6c757d; color:white; border:none;">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Coupon Detail Modal -->
    <div id="couponModal">
        <div class="box" style="max-width:600px;">
            <h3>🎟️ รายละเอียดคูปอง</h3>
            <div id="couponContent" class="coupon-detail-content"></div>
            <div style="margin-top:16px; text-align:right;">
                <button id="couponClose" style="background:#6c757d; color:white; border:none;">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Confirm Dialog -->
    <div id="confirmModal">
        <div class="box">
            <h3>✂️ ยืนยันการตัดคูปอง</h3>
            <div class="confirm-message" id="confirmMessage"></div>
            <div class="confirm-actions">
                <button id="confirmYes" class="btn-confirm">✓ ใช่, ตัดคูปอง</button>
                <button id="confirmNo" class="btn-cancel">✗ ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Export Date Range Modal -->
    <div id="exportModal">
        <div class="box">
            <h3>เลือกรายงานตามช่วงวันที่</h3>
            <div class="row">
                <label for="exportDateFrom">วันที่เริ่ม (จาก):</label>
                <input id="exportDateFrom" type="date" />
            </div>
            <div class="row">
                <label for="exportDateTo">วันที่สิ้นสุด (ถึง):</label>
                <input id="exportDateTo" type="date" />
            </div>

            <div id="exportError" style="color:#dc3545; margin-top:8px; display:none; font-size:13px;"></div>
            <div style="margin-top:8px; color:#6c757d; font-size:13px;">หมายเหตุ: ระบบจะส่งช่วงเวลาในรูปแบบวันที่เริ่มต้นเวลา00:00:00 และวันที่สิ้นสุดเวลา23:59:59 ตามเวลาท้องถิ่นของผู้ใช้<br>
            รายงานจะแสดงทั้งข้อมูลรายละเอียดและสรุปในไฟล์เดียวกัน</div>
            <div class="actions">
                <button id="exportCancel" class="btn-cancel">ยกเลิก</button>
                <button id="exportConfirm" class="btn-export">ดาวน์โหลด</button>
            </div>
        </div>
    </div>

    <!-- Load SheetJS for Excel generation (used by Today Report) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
        integrity="sha512-+6kX1gVvJ9pPZfE0BqVdW4Qj9t6eY0Vx4eZkqQj3w1Y7z3Kp6o8Qqzj2X5s1QyCk3F8x7sK4q9zJb1q2YV2w=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
    function $(id) {
        return document.getElementById(id);
    }

    const currentUser = (function() {
        try {
            return sessionStorage.getItem('currentUser') || '';
        } catch (e) {
            return '';
        }
    })();
    if (!currentUser) {
        try {
            window.location.href = '/login.html';
        } catch (e) {}
    }

    $('logoutBtn').addEventListener('click', () => {
        if (confirm('คุณต้องการออกจากระบบหรือไม่?')) {
            try {
                sessionStorage.removeItem('currentUser');
            } catch (e) {}

            window.location.href = '/login.html';
        }
    });

    const resultsBody = document.querySelector('#results tbody');
    const summaryEl = $('summary');
    const pageInfo = $('pageInfo');
    const errorEl = $('error');
    let currentData = [];
    let page = 1,
        totalPages = 1;
    let currentReceiptId = null; // เก็บ receiptId ปัจจุบันสำหรับ reload

    // Clear Date Button
    $('btnClearDate').addEventListener('click', () => {
        $('dateFrom').value = '';
        $('dateTo').value = '';
        page = 1;
        loadReceipts();
    });

    function parseNaiveAsLocal(s) {
        if (!s) return null;
        if (typeof s !== 'string') return new Date(s);
        // naive ISO without timezone: YYYY-MM-DDTHH:mm:ss or with seconds fraction
        var m = /^\s*(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.\d+)?\s*$/.exec(s);
        if (m) {
            var y = parseInt(m[1], 10),
                mo = parseInt(m[2], 10) - 1,
                d = parseInt(m[3], 10);
            var hh = parseInt(m[4], 10),
                mm = parseInt(m[5], 10),
                ss = parseInt(m[6], 10);
            return new Date(y, mo, d, hh, mm, ss);
        }
        // fallback - let Date parse strings with timezone or other formats
        var dt = new Date(s);
        return isNaN(dt) ? null : dt;
    }

    function formatDate(d) {
        if (!d) return '';
        try {
            var dt = parseNaiveAsLocal(d);
            if (!dt || isNaN(dt)) return d;
            return dt.toLocaleString('th-TH', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch {
            return d;
        }
    }

    function formatCurrency(amount) {
        return (amount || 0).toLocaleString('th-TH', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function getFilterValues() {
        return {
            receiptCode: $('searchReceiptCode').value.trim(),
            couponCode: $('searchCouponCode').value.trim(),
            customerName: $('searchCustomerName').value.trim(),
            customerPhone: $('searchPhone').value.trim(),
            status: $('searchStatus').value,
            dateFrom: $('dateFrom').value,
            dateTo: $('dateTo').value,
            pageSize: parseInt($('pageSize').value, 10) || 25
        };
    }

    async function loadReceipts() {
        errorEl.textContent = '';
        const filters = getFilterValues();

        const params = new URLSearchParams();
        params.append('page', page);
        params.append('pageSize', filters.pageSize);
        if (filters.receiptCode) params.append('receiptCode', filters.receiptCode);
        if (filters.couponCode) params.append('couponCode', filters.couponCode);
        if (filters.customerName) params.append('customerName', filters.customerName);
        if (filters.customerPhone) params.append('customerPhone', filters.customerPhone);
        if (filters.status) params.append('status', filters.status);
        else params.append('status', 'Active');
        // send ISO8601 with timezone: construct local start/end and send toISOString()
        if (filters.dateFrom) {
            try {
                const parts = filters.dateFrom.split('-').map(Number);
                const fromLocal = new Date(parts[0], parts[1] - 1, parts[2], 0, 0, 0, 0); // local midnight
                params.append('dateFrom', fromLocal.toISOString());
            } catch (e) {
                params.append('dateFrom', filters.dateFrom + 'T00:00:00');
            }
        }
        if (filters.dateTo) {
            try {
                const parts = filters.dateTo.split('-').map(Number);
                const toLocal = new Date(parts[0], parts[1] - 1, parts[2], 23, 59, 59, 999); // local end of day
                params.append('dateTo', toLocal.toISOString());
            } catch (e) {
                params.append('dateTo', filters.dateTo + 'T23:59:59');
            }
        }

        console.log('Loading receipts with params:', params.toString());

        try {
            const resp = await fetch('/api/Receipts?' + params.toString());
            if (!resp.ok) {
                errorEl.textContent = 'HTTP ' + resp.status + ' - ' + resp.statusText;
                resultsBody.innerHTML = '';
                summaryEl.textContent = '-';
                pageInfo.textContent = '';
                return;
            }
            const data = await resp.json();
            console.log('Loaded receipts:', data.items?.length || 0, 'items');
            renderReceipts(data);
        } catch (err) {
            console.error('Error loading receipts:', err);
            errorEl.textContent = 'เกิดข้อผิดพลาด: ' + err.message;
        }
    }

        // ฟังก์ชันตรวจสอบว่าคูปองถูกตัดแล้วหรือไม่ (พร้อมข้อมูลวันที่)
        async function checkCouponRedeemed(generatedCodes) {
            if (!generatedCodes || generatedCodes.length === 0) {
                return {
                    allRedeemed: false,
                    redeemedCodes: [],
                    redeemedDetails: {},
                    complimentaryCodes: [],
                    totalCodes: 0
                };
            }

            try {
                // เรียก API เพื่อเช็คสถานะของแต่ละ code
                const checks = await Promise.all(
                    generatedCodes.map(async (code) => {
                        try {
                            const resp = await fetch(`/api/GeneratedCoupons/bycode/${encodeURIComponent(code)}`);
                            if (resp.ok) {
                                try {
                                    const text = await resp.text();
                                    if (!text) return {
                                        code,
                                        isUsed: false,
                                        isComplimentary: false,
                                        usedDate: null,
                                        usedBy: null
                                    };
                                    const parsed = JSON.parse(text);
                                    // Normalize: server returns 'generatedCode' field
                                    return {
                                        code: parsed.generatedCode ?? code,
                                        isUsed: parsed.isUsed || false,
                                        isComplimentary: parsed.isComplimentary || false,
                                        usedDate: parsed.usedDate || parsed.redeemedAt || null,
                                        usedBy: parsed.usedBy || parsed.redeemedBy || null,
                                        id: parsed.id ?? null
                                    };
                                } catch {
                                    return {
                                        code,
                                        isUsed: false,
                                        isComplimentary: false,
                                        usedDate: null,
                                        usedBy: null
                                    }
                                }
                            }
                            return {
                                code,
                                isUsed: false,
                                isComplimentary: false,
                                usedDate: null,
                                usedBy: null
                            };
                        } catch {
                            return {
                                code,
                                isUsed: false,
                                isComplimentary: false,
                                usedDate: null,
                                usedBy: null
                            };
                        };
                    })
                );

                const redeemedCodes = checks.filter(c => c && c.isUsed).map(c => c.code);
                const complimentaryCodes = checks.filter(c => c && c.isComplimentary).map(c => c.code);
                const allRedeemed = checks.length > 0 && checks.every(c => c && c.isUsed);

                // สร้าง object เก็บข้อมูลวันที่ตัดของแต่ละ code
                const redeemedDetails = {};
                checks.filter(c => c && c.isUsed).forEach(c => {
                    redeemedDetails[c.code] = {
                        usedDate: c.usedDate,
                        usedBy: c.usedBy
                    };
                });

                return {
                    allRedeemed,
                    redeemedCodes,
                    redeemedDetails,
                    complimentaryCodes,
                    totalCodes: generatedCodes.length
                };
            } catch (err) {
                console.error('Error checking coupon redeemed:', err);
                return {
                    allRedeemed: false,
                    redeemedCodes: [],
                    redeemedDetails: {},
                    complimentaryCodes: [],
                    totalCodes: 0
                };
            }
        }

    async function showDetail(receiptId) {
        try {
            console.log('Loading receipt detail:', receiptId);
            currentReceiptId = receiptId;
            const resp = await fetch(`/api/Receipts/${receiptId}`);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const receipt = await resp.json();
            console.log('Loaded receipt detail:', receipt);

            const statusClass = receipt.status === 'Active' ? 'status-active' : 'status-cancelled';
            const totalBeforeDiscount = receipt.totalAmount + receipt.discount;

            // Left Column: Receipt Information
            const receiptInfoHtml = `
 <div class="detail-section">
 <h4>ข้อมูลใบเสร็จ</h4>
 <div class="detail-row"><div class="detail-label">รหัสใบเสร็จ:</div>
 <div class="detail-value">${escapeHtml(receipt.receiptCode)}</div>
 
 </div>
 <div class="detail-row">
 <div class="detail-label">วันที่:</div>
 <div class="detail-value">${formatDate(receipt.receiptDate)}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">สถานะ:</div>
 <div class="detail-value"><span class="${statusClass}">${escapeHtml(receipt.statusText)}</span></div>
 </div>
 </div>
 
 <div class="detail-section">
 <h4>ข้อมูลลูกค้า</h4>
 <div class="detail-row">
 <div class="detail-label">ชื่อลูกค้า:</div>
 <div class="detail-value">${escapeHtml(receipt.customerName)}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">เบอร์โทรศัพท์:</div>
 <div class="detail-value">${escapeHtml(receipt.customerPhoneNumber)}</div>
 </div>
 </div>
 
 <div class="detail-section">
 <h4>ข้อมูลการขาย</h4>
 <div class="detail-row">
 <div class="detail-label">เซลล์:</div>
 <div class="detail-value">${escapeHtml(receipt.salesPersonName || '-')}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">เบอร์โทรเซลล์:</div>
 <div class="detail-value">${escapeHtml(receipt.salesPersonPhone || '-')}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">วิธีการชำระเงิน:</div>
 <div class="detail-value">${escapeHtml(receipt.paymentMethodName || '-')}</div>
 </div>
 </div>
 
 <div class="detail-section">
 <h4>ยอดเงิน</h4>
 <div class="detail-row">
 <div class="detail-label">ยอดรวมก่อนส่วนลด:</div>
 <div class="detail-value">${formatCurrency(totalBeforeDiscount)} บาท</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">ส่วนลด:</div>
 <div class="detail-value" style="color:#dc3545;">${formatCurrency(receipt.discount)} บาท</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">ยอดสุทธิ:</div>
 <div class="detail-value" style="font-weight:bold; color:#28a745; font-size:16px;">${formatCurrency(receipt.totalAmount)} บาท</div>
 </div>
 </div>
 `;

            $('detailContent').innerHTML = receiptInfoHtml;

            // Right Column: Items List - แสดง Loading ก่อน
            $('itemsList').innerHTML = '<p style="text-align:center; padding:20px; color:#6c757d;">กำลังโหลดข้อมูล...</p>';

            // โหลดและแสดง items พร้อมตรวจสอบสถานะ
            if (receipt.items && receipt.items.length > 0) {
                let itemsHtml = '';

                for (const item of receipt.items) {
                    // normalize generated codes property (handle different casing)
                    const generatedCodes = item.generatedCodes || item.GeneratedCodes || item.generatedCodesList || item.GeneratedCodesList || [];
                    const codesText = Array.isArray(generatedCodes) && generatedCodes.length > 0 ? generatedCodes.join(', ') : 'ไม่มีรหัสคูปอง';

                    // check status using normalized codes
                    const redeemStatus = await checkCouponRedeemed(generatedCodes);
                    const hasUnusedCoupons = Array.isArray(generatedCodes) && generatedCodes.length > 0 && !redeemStatus.allRedeemed;
                    const isRedeemed = Array.isArray(generatedCodes) && generatedCodes.length > 0 && redeemStatus.allRedeemed;
                    const cardClass = isRedeemed ? 'item-card redeemed' : 'item-card';

                    // สร้างข้อความสถานะ
                    // สร้างข้อความสถานะพร้อมวันที่ตัด
                    let statusBadge = '';
                    if (isRedeemed) {
                        // หาวันที่ตัดล่าสุด
                        let latestDate = null;
                        let latestBy = null;
                        redeemStatus.redeemedCodes.forEach(code => {
                            if (redeemStatus.redeemedDetails[code]) {
                                const detail = redeemStatus.redeemedDetails[code];
                                if (detail.usedDate && (!latestDate || new Date(detail.usedDate) > new Date(latestDate))) {
                                    latestDate = detail.usedDate;
                                    latestBy = detail.usedBy;
                                }
                            }
                        });

                        statusBadge = `
                            <div class="redeemed-info">
                                <div class="redeemed-badge">✂️ คูปองใบนี้ถูกตัดไปแล้ว</div>
                                ${latestDate ? `<div class="redeemed-date">⏰ ตัดเมื่อ: ${formatDate(latestDate)}</div>` : ''}
                                ${latestBy ? `<div class="redeemed-date">👤 ตัดโดย: ${escapeHtml(latestBy)}</div>` : ''}
                            </div>
                        `;
                    } else if (redeemStatus.redeemedCodes && redeemStatus.redeemedCodes.length > 0) {
                        // หาวันที่ตัดล่าสุด
                        let latestDate = null;
                        let latestBy = null;
                        redeemStatus.redeemedCodes.forEach(code => {
                            if (redeemStatus.redeemedDetails[code]) {
                                const detail = redeemStatus.redeemedDetails[code];
                                if (detail.usedDate && (!latestDate || new Date(detail.usedDate) > new Date(latestDate))) {
                                    latestDate = detail.usedDate;
                                    latestBy = detail.usedBy;
                                }
                            }
                        });

                        statusBadge = `
                            <div class="redeemed-info">
                                <div class="redeemed-badge">✂️ ตัดไปแล้ว ${redeemStatus.redeemedCodes.length}/${redeemStatus.totalCodes} ใบ</div>
                                ${latestDate ? `<div class="redeemed-date">⏰ ตัดล่าสุด: ${formatDate(latestDate)}</div>` : ''}
                                ${latestBy ? `<div class="redeemed-date">👤 โดย: ${escapeHtml(latestBy)}</div>` : ''}
                            </div>
                        `;
                    }

                    // เพิ่ม COM badge ถ้ามีคูปองฟรี
                    let comBadge = '';
                    if (redeemStatus.complimentaryCodes && redeemStatus.complimentaryCodes.length > 0) {
                        comBadge = `<div class="redeemed-badge" style="background:#17a2b8;">🎁 COM (ฟรี)</div>`;
                    }

                    // per-item COM checkbox (disabled so it only shows status)
                    const isComplimentary = redeemStatus.complimentaryCodes && redeemStatus.complimentaryCodes.length > 0;

                    // ensure receipt id property handled
                    const rid = receipt.ReceiptID ?? receipt.receiptID ?? receipt.id ?? '';

                    // Display generated codes instead of coupon definition code
                    const displayCode = generatedCodes.length > 0 ? generatedCodes[0] : (item.couponCode || item.CouponCode || '');

                    itemsHtml += `
 <div class="${cardClass}" data-generated='${escapeHtml(JSON.stringify(generatedCodes))}'>
 <div class="item-header">
 <input type="checkbox" class="bulk-select" data-generated='${escapeHtml(JSON.stringify(generatedCodes))}' style="margin:0;">
 <div class="item-name">${escapeHtml(item.couponName || item.CouponName || '')}</div>
 </div>
 <div class="item-code">รหัส: ${escapeHtml(displayCode)}</div>
 ${statusBadge ? `<div style="flex: 0 0 auto;">${statusBadge}</div>` : ''}
 ${comBadge ? `<div style="flex: 0 0 auto;">${comBadge}</div>` : ''}
 <div class="item-price">${formatCurrency(item.totalPrice || item.TotalPrice || 0)} บาท</div>
 <div class="item-actions">
 <label>
 <input type="checkbox" class="item-com-checkbox" ${isComplimentary ? 'checked' : ''} style="margin:0;"> COM (ฟรี)
 </label>
 <button class="item-btn btn-view" data-coupon-code="${escapeHtml(item.couponCode || item.CouponCode || '')}">
 📋 ดูรายละเอียด
 </button>
 <button class="item-btn btn-cancel-redeem" 
 ${!(redeemStatus.redeemedCodes && redeemStatus.redeemedCodes.length>0) ? 'disabled' : ''}
 data-receipt-id="${rid}"
 data-coupon-code="${escapeHtml(item.couponCode || item.CouponCode || '')}"
 data-generated-codes='${escapeHtml(JSON.stringify(generatedCodes))}'>
 ✖️ ยกเลิก
 </button>
 </div>
 </div>
 `;
                }

                $('itemsList').innerHTML = itemsHtml;
            } else {
                $('itemsList').innerHTML = '<p style="color:#6c757d; text-align:center; padding:20px;">ไม่มีรายการสินค้า</p>';
            }

            // Attach event listeners (with debug logs)
            document.querySelectorAll('.btn-view').forEach(btn => btn.addEventListener('click', (e) => {
                const couponCode = e.currentTarget.dataset.couponCode;
                console.log('View coupon clicked', couponCode);
                viewCouponDetail(couponCode);
            }));

            document.querySelectorAll('.item-com-checkbox').forEach(chk => {
                chk.addEventListener('change', async (e) => {
                    const checkbox = e.currentTarget;
                    const itemCard = checkbox.closest('.item-card');
                    // find generated codes from the redeem button dataset if present
                    const redeemBtn = itemCard ? itemCard.querySelector('.btn-redeem') : null;
                    const generatedCodes = redeemBtn ? (JSON.parse(redeemBtn.dataset.generatedCodes || '[]')) : [];
                    const setTo = checkbox.checked === true;

                    if (!generatedCodes || generatedCodes.length === 0) {
                        // nothing to update
                        return;
                    }

                    // disable while updating
                    checkbox.disabled = true;
                    try {
                        // send requests for all generated codes in parallel
                        const results = await Promise.all(generatedCodes.map(async (code) => {
                            try {
                                const resp = await fetch('/api/GeneratedCoupons/set-complimentary', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        code: code,
                                        isComplimentary: setTo
                                    })
                                });
                                if (!resp.ok) {
                                    const txt = await resp.text();
                                    throw new Error('HTTP ' + resp.status + ' - ' + txt);
                                }
                                return true;
                            } catch (err) {
                                console.error('Failed to set complimentary for', code, err);
                                return false;
                            }
                        }));

                        if (results.some(r => r === false)) {
                            throw new Error('Some codes failed to update');
                        }
                    } catch (err) {
                        console.error('Error updating complimentary flag:', err);
                        alert('ไม่สามารถเปลี่ยนสถานะ COM ได้: ' + err.message);
                        // revert checkbox
                        checkbox.checked = !setTo;
                    } finally {
                        checkbox.disabled = false;
                    }
                });
            });

            document.querySelectorAll('.btn-cancel-redeem').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', (e) => {
                        const el = e.currentTarget;
                        console.log('Cancel redeem clicked, dataset=', el.dataset);
                        const generatedCodes = JSON.parse(el.dataset.generatedCodes || el.dataset.generatedcodes || '[]');

                        // find redeemed codes by querying API for each generated code
                        (async () => {
                            try {
                                const checks = await Promise.all(generatedCodes.map(async code => {
                                    try {
                                        const resp = await fetch(`/api/GeneratedCoupons/bycode/${encodeURIComponent(code)}`);
                                        if (resp.ok) {
                                            try {
                                                const text = await resp.text();
                                                const parsed = text ? JSON.parse(text) : null;
                                                // normalize to same shape as checkCouponRedeemed
                                                return parsed ? {
                                                    code: parsed.generatedCode ?? code,
                                                    isUsed: parsed.isUsed || false,
                                                    isComplimentary: parsed.isComplimentary || false,
                                                    id: parsed.id ?? null
                                                } : {
                                                    code,
                                                    isUsed: false,
                                                    isComplimentary: false,
                                                    id: null
                                                };
                                            } catch {
                                                return {
                                                    code,
                                                    isUsed: false,
                                                    isComplimentary: false,
                                                    id: null
                                                };
                                            }
                                        }
                                        return {
                                            code,
                                            isUsed: false,
                                            isComplimentary: false,
                                            id: null
                                        };
                                    } catch {
                                        return {
                                            code,
                                            isUsed: false,
                                            isComplimentary: false,
                                            id: null
                                        };
                                    }
                                }));

                                const used = checks.filter(c => c && c.isUsed).map(c => c.code);
                                if (!used || used.length === 0) {
                                    alert('ไม่พบคูปองที่ถูกตัดไว้สำหรับยกเลิก');
                                    return;
                                }

                                // choose the most recently used code if available (last in array)
                                const codeToCancel = used[used.length - 1];

                                const message = `
 <p>คุณต้องการยกเลิกการตัดคูปองนี้ใช่หรือไม่?</p>
 <p style="margin-top:10px;"><strong>รหัสคูปองที่จะยกเลิก:</strong> <span class="coupon-code-highlight">${escapeHtml(codeToCancel)}</span></p>
 <p style="margin-top:10px; color:#dc3545;">⚠️ การยกเลิกจะเปลี่ยนสถานะคูปองกลับเป็นยังไม่ได้ใช้</p>
 `;

                                showConfirmDialog(message, async () => {
                                    try {
                                        // First fetch the generated coupon record to get its internal id (if available)
                                        let genRecord = null;
                                        try {
                                            const gResp = await fetch(`/api/GeneratedCoupons/bycode/${encodeURIComponent(codeToCancel)}`);
                                            if (gResp.ok) {
                                                try {
                                                    const txt = await gResp.text();
                                                    genRecord = txt ? JSON.parse(txt) : null;
                                                } catch {
                                                    genRecord = null;
                                                }
                                            }
                                        } catch (ex) {
                                            console.warn('Failed to fetch generated coupon record', ex);
                                            genRecord = null;
                                        }

                                        // Prepare payload for reset endpoint — include id if we found one, and always include code
                                        const payload = {
                                            code: codeToCancel,
                                            cancelledBy: currentUser
                                        };
                                        // try to set id from common property names
                                        if (genRecord) {
                                            payload.id = genRecord.id || genRecord.generatedCouponId || genRecord.GeneratedCouponId || genRecord.GeneratedCouponID || genRecord.couponId || genRecord.idGenerated || null;
                                        }

                                        // Call reset endpoint that backend should implement to clear IsUsed/UsedBy/UsedDate
                                        const resp = await fetch('/api/GeneratedCoupons/reset', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify(payload)
                                        });

                                        let result = null;
                                        try {
                                            const text = await resp.text();
                                            result = text ? JSON.parse(text) : null;
                                        } catch (pe) {
                                            console.warn('Reset response not JSON or empty', pe);
                                            result = null;
                                        }

                                        if (resp.ok && result && (result.result === 'Success' || result.success === true)) {
                                            alert('✓ ยกเลิกการตัดคูปองเรียบร้อยแล้ว');
                                            if (currentReceiptId) await showDetail(currentReceiptId);
                                        } else if (resp.ok && !result) {
                                            // backend returned200 with empty body — treat as success
                                            alert('✓ ยกเลิกการตัดคูปองเรียบร้อยแล้ว');
                                            if (currentReceiptId) await showDetail(currentReceiptId);
                                        } else {
                                            let errMsg = 'ไม่สามารถยกเลิกคูปองได้';
                                            if (result && result.message) errMsg = result.message;
                                            alert('❌ ' + errMsg);
                                        }
                                    } catch (err) {
                                        console.error('Error cancelling redemption:', err);
                                        alert('เกิดข้อผิดพลาด: ' + err.message);
                                    }
                                });

                            } catch (err) {
                                console.error('Error finding redeemed codes:', err);
                                alert('เกิดข้อผิดพลาด: ' + err.message);
                            }
                        })();
                    });
                }
            });

            // Bulk selection and actions
            const searchBox = $('searchGeneratedCodes');
             const bulkRedeemBtn = $('bulkRedeemBtn');

            function applyGeneratedSearchFilter() {
                const q = (searchBox.value || '').trim().toLowerCase();
                document.querySelectorAll('#itemsList .item-card').forEach(card => {
                    const codes = (card.getAttribute('data-generated') || '').toLowerCase();
                    const name = (card.querySelector('.item-name')?.textContent || '').toLowerCase();
                    if (!q || codes.indexOf(q) >= 0 || name.indexOf(q) >= 0) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }

            searchBox.addEventListener('input', () => {
                applyGeneratedSearchFilter();
            });

            // Function to update bulk redeem button state
            function updateBulkRedeemButtonState() {
                const selectedCount = Array.from(document.querySelectorAll('#itemsList .bulk-select:checked')).length;
                bulkRedeemBtn.disabled = selectedCount === 0;
            }

            // Attach change event to all bulk select checkboxes
            function attachBulkSelectListeners() {
                document.querySelectorAll('#itemsList .bulk-select').forEach(checkbox => {
                    checkbox.addEventListener('change', updateBulkRedeemButtonState);
                });
            }

            // Initial update and attach listeners
            attachBulkSelectListeners();
            updateBulkRedeemButtonState();

            // Bulk redeem: for each selected item pick the first unused generated code and redeem it
            async function bulkRedeemSelectedItems() {
                const selected = Array.from(document.querySelectorAll('#itemsList .bulk-select')).filter(cb => cb.checked);
                if (selected.length === 0) { alert('กรุณาเลือกอย่างน้อย 1 รายการ'); return; }

                // Prepare list of coupons to be redeemed for confirmation
                const couponList = [];
                for (const cb of selected) {
                    const itemCard = cb.closest('.item-card');
                    // Get coupon definition name from item-name element
                    const couponDefinitionName = itemCard.querySelector('.item-name')?.textContent || 'ไม่ระบุชื่อ';
                    const codes = JSON.parse(cb.getAttribute('data-generated') || '[]');
                    
                    // Find first unused code
                    let firstUnusedCode = null;
                    for (const code of codes) {
                        try {
                            const resp = await fetch(`/api/GeneratedCoupons/bycode/${encodeURIComponent(code)}`);
                            if (resp.ok) {
                                const txt = await resp.text();
                                const parsed = txt ? JSON.parse(txt) : null;
                                if (parsed && !parsed.isUsed) { 
                                    firstUnusedCode = code; 
                                    break; 
                                }
                                if (!parsed) { 
                                    firstUnusedCode = code; 
                                    break; 
                                }
                            }
                        } catch (ex) { 
                            console.warn('check code error', code, ex); 
                        }
                    }

                    if (firstUnusedCode) {
                        couponList.push({
                            definitionName: couponDefinitionName,
                            generatedCode: firstUnusedCode
                        });
                    } else {
                        couponList.push({
                            definitionName: couponDefinitionName,
                            generatedCode: '(ไม่มีรหัสว่าง)',
                            hasError: true
                        });
                    }
                }

                // Build confirmation message with list of coupons
                let couponListHtml = '<div style="max-height: 300px; overflow-y: auto; margin: 10px 0;">';
                couponListHtml += '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
                couponListHtml += '<thead><tr style="background: #f8f9fa;">';
                couponListHtml += '<th style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">ชื่อคูปอง</th>';
                couponListHtml += '<th style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">รหัสคูปอง</th>';
                couponListHtml += '</tr></thead>';
                couponListHtml += '<tbody>';
                
                couponList.forEach(item => {
                    const rowStyle = item.hasError ? 'background: #ffe6e6;' : '';
                    const codeStyle = item.hasError ? 'color: #dc3545; font-weight: bold;' : 'color: #856404; background: #fff3cd; padding: 2px 6px; border-radius: 3px; display: inline-block;';
                    couponListHtml += `<tr style="${rowStyle}">
                        <td style="padding: 8px; border: 1px solid #dee2e6;">${escapeHtml(item.definitionName)}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;"><span style="${codeStyle}">${escapeHtml(item.generatedCode)}</span></td>
                    </tr>`;
                });
                
                couponListHtml += '</tbody></table></div>';

                const validCount = couponList.filter(c => !c.hasError).length;
                const errorCount = couponList.filter(c => c.hasError).length;

                let message = `<p><strong>คุณต้องการตัดคูปองทั้งหมด ${selected.length} รายการที่เลือก ใช่หรือไม่?</strong></p>`;
                message += couponListHtml;
                message += `<p style="margin-top: 10px; font-size: 13px; color: #495057;">✓ สามารถตัดได้: <strong style="color: #28a745;">${validCount}</strong> รายการ</p>`;
                if (errorCount > 0) {
                    message += `<p style="margin-top: 5px; font-size: 13px; color: #dc3545;">⚠️ ไม่สามารถตัด: <strong>${errorCount}</strong> รายการ (ไม่มีรหัสว่าง)</p>`;
                }
                message += `<p style="margin-top: 10px; color: #6c757d; font-size: 12px;">หมายเหตุ: แต่ละรายการจะตัดเฉพาะ 1 ใบ</p>`;

                // Show confirmation dialog
                showConfirmDialog(message, async () => {
                    const results = [];

                    for (const cb of selected) {
                        const codes = JSON.parse(cb.getAttribute('data-generated') || '[]');
                        if (!codes || codes.length === 0) { results.push({ ok: false, reason: 'ไม่มีรหัส' }); continue; }

                        // find first unused code
                        let codeToRedeem = null;
                        for (const code of codes) {
                            try {
                                const resp = await fetch(`/api/GeneratedCoupons/bycode/${encodeURIComponent(code)}`);
                                if (resp.ok) {
                                    const txt = await resp.text();
                                    const parsed = txt ? JSON.parse(txt) : null;
                                    if (parsed && !parsed.isUsed) { codeToRedeem = code; break; }
                                    if (!parsed) { codeToRedeem = code; break; } // if no data assume unused
                                } else {
                                    // ignore and continue
                                }
                            } catch (ex) { console.warn('check code error', code, ex); }
                        }

                        if (!codeToRedeem) { results.push({ ok: false, reason: 'ไม่มีรหัสว่าง' }); continue; }

                        try {
                            // optional: mark COM if item's item-com-checkbox is checked
                            const itemCard = cb.closest('.item-card');
                            const comCheckbox = itemCard ? itemCard.querySelector('.item-com-checkbox') : null;
                            const isCom = comCheckbox ? comCheckbox.checked : false;

                            if (isCom) {
                                // mark complimentary first
                                try { await fetch('/api/GeneratedCoupons/set-complimentary', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: codeToRedeem, isComplimentary: true }) }); } catch {}
                            }

                            // redeem
                            const pad = (n) => String(n).padStart(2, '0');
                            const nowLocal = new Date();
                            const redeemedAtLocal = `${nowLocal.getFullYear()}-${pad(nowLocal.getMonth() + 1)}-${pad(nowLocal.getDate())}T${pad(nowLocal.getHours())}:${pad(nowLocal.getMinutes())}:${pad(nowLocal.getSeconds())}`;

                            const resp = await fetch('/api/CouponRedemption/redeem', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ code: codeToRedeem, redeemedBy: currentUser, receiptItemId: null, redeemedAt: redeemedAtLocal })
                            });

                            const text = await resp.text();
                            const parsed = text ? JSON.parse(text) : null;

                            if (resp.ok && parsed && parsed.result === 'Success') {
                                results.push({ ok: true, code: codeToRedeem });
                            } else if (resp.ok && !parsed) {
                                results.push({ ok: true, code: codeToRedeem });
                            } else {
                                results.push({ ok: false, code: codeToRedeem, reason: (parsed && parsed.message) || 'failed' });
                            }
                        } catch (err) {
                            console.error('bulk redeem error', err);
                            results.push({ ok: false, reason: err.message });
                        }
                    }

                    const success = results.filter(r => r.ok).length;
                    const fail = results.length - success;
                    alert(`สำเร็จ ${success} รายการ, ล้มเหลว ${fail} รายการ`);
                    if (currentReceiptId) await showDetail(currentReceiptId);
                });
            }
            $('detailModal').style.display = 'flex';
            bulkRedeemBtn.addEventListener('click', () => {
                bulkRedeemSelectedItems();
            });
        } catch (err) {
            console.error('Error showing detail:', err);
            alert('ไม่สามารถแสดงรายละเอียดได้: ' + err.message);
        }
    }

    async function showCouponDetail(couponCode) {
        try {
            console.log('Loading coupon detail:', couponCode);

            const resp = await fetch(`/api/Coupons/${couponCode}`);
            if (!resp.ok) {
                throw new Error('HTTP ' + resp.status);
            }

            const coupon = await resp.json();
            console.log('Loaded coupon detail:', coupon);

            const statusClass = coupon.status === 'Active' ? 'status-active' : 'status-cancelled';

            const couponInfoHtml = `
 <div class="detail-section">
 <h4>ข้อมูลคูปอง</h4>
 <div class="detail-row">
 <div class="detail-label">รหัสคูปอง:</div>
 <div class="detail-value">${escapeHtml(coupon.couponCode)}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">ชื่อคูปอง:</div>
 <div class="detail-value">${escapeHtml(coupon.couponName)}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">สถานะ:</div>
 <div class="detail-value"><span class="${statusClass}">${escapeHtml(coupon.statusText)}</span></div>
 </div>
 <div class="detail-row">
 <div class="detail-label">วันที่สร้าง:</div>
 <div class="detail-value">${formatDate(coupon.createDate)}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">วันที่หมดอายุ:</div>
 <div class="detail-value">${formatDate(coupon.expireDate)}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">จำนวนการใช้งาน:</div>
 <div class="detail-value">${escapeHtml(coupon.usageCount || 0)}</div>
 </div>
 </div>
 
 <div class="detail-section">
 <h4>ข้อมูลการใช้งาน</h4>
 <div class="detail-row">
 <div class="detail-label">รหัสใบเสร็จที่ใช้งานล่าสุด:</div>
 <div class="detail-value">${escapeHtml(coupon.lastUsedReceipt || '-')}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">วันที่ใช้งานล่าสุด:</div>
 <div class="detail-value">${formatDate(coupon.lastUsedDate)}</div>
 </div>
 </div>
 `;

            $('couponContent').innerHTML = couponInfoHtml;
            $('couponModal').style.display = 'flex';
        } catch (err) {
            console.error('Error showing coupon detail:', err);
            alert('ไม่สามารถแสดงรายละเอียดคูปองได้: ' + err.message);
        }
    }

    // Helper functions for item actions
    async function viewCouponDetail(couponCode) {
        try {
            console.log('Loading coupon detail:', couponCode);

            // เรียก API endpoint ใหม่ที่ส่งข้อมูลละเอียด
            const resp = await fetch(`/api/CouponDefinitions/bycode/${encodeURIComponent(couponCode)}`);
            if (!resp.ok) {
                if (resp.status === 404) {
                    throw new Error('ไม่พบข้อมูลคูปอง: ' + couponCode);
                }
                throw new Error('HTTP ' + resp.status);
            }

            const coupon = await resp.json();
            console.log('Loaded coupon detail:', coupon);

            // Format dates
            const validFrom = coupon.validFrom ? formatDate(coupon.validFrom) : '-';
            const validTo = coupon.validTo ? formatDate(coupon.validTo) : '-';

            // Format description with line breaks
            const description = (coupon.description || 'ไม่มีรายละเอียด').replace(/\n/g, '<br>');

            // สถานะ
            let statusBadge = '';
            if (!coupon.isActive) {
                statusBadge = '<span style="color:#dc3545; font-weight:bold;">✗ ปิดใช้งาน</span>';
            } else if (coupon.isExpired) {
                statusBadge = '<span style="color:#dc3545; font-weight:bold;">⏰ หมดอายุ</span>';
            } else if (coupon.isCurrentlyValid) {
                statusBadge = '<span style="color:#28a745; font-weight:bold;">✓ ใช้งานได้</span>';
            } else {
                statusBadge = '<span style="color:#ffc107; font-weight:bold;">⏳ ยังไม่เริ่ม</span>';
            }

            const html = `
 <div class="coupon-detail-section">
 <h4>ข้อมูลพื้นฐาน</h4>
 <div class="coupon-detail-row">
 <div class="coupon-detail-label">รหัสคูปอง:</div>
 <div class="coupon-detail-value"><strong>${escapeHtml(coupon.code)}</strong></div>
 </div>
 <div class="coupon-detail-row">
 <div class="coupon-detail-label">ชื่อคูปอง:</div>
 <div class="coupon-detail-value">${escapeHtml(coupon.name)}</div>
 </div>
 <div class="coupon-detail-row">
 <div class="coupon-detail-label">สาขา:</div>
 <div class="coupon-detail-value">${escapeHtml(coupon.Branch || '-')}</div>
 </div>
 <div class="coupon-detail-row">
 <div class="coupon-detail-label">ราคา:</div>
 <div class="coupon-detail-value">
 <span class="coupon-price">${formatCurrency(coupon.price)} บาท</span>
 </div>
 </div>
 <div class="coupon-detail-row">
 <div class="coupon-detail-label">สถานะ:</div>
 <div class="coupon-detail-value">${statusBadge}</div>
 </div>
 </div>
 
 <div class="coupon-detail-section">
 <h4>รายละเอียด</h4>
 <div class="coupon-description">${description}</div>
 </div>
 
 <div class="coupon-detail-section">
 <h4>ข้อมูลการใช้งาน</h4>
 <div class="coupon-detail-row">
 <div class="coupon-detail-label">วันที่เริ่มใช้งาน:</div>
 <div class="coupon-detail-value">${validFrom}</div>
 </div>
 <div class="coupon-detail-row">
 <div class="coupon-detail-label">วันหมดอายุ:</div>
 <div class="coupon-detail-value" style="${coupon.isExpired ? 'color:#dc3545; font-weight:bold;' : ''}">${validTo}</div>
 </div>
 ${coupon.expiryDays > 0 ? `
 <div class="coupon-detail-row">
 <div class="coupon-detail-label">อายุการใช้งาน:</div>
 <div class="coupon-detail-value">${coupon.expiryDays} วัน</div>
 </div>
 ` : ''}

 <div class="coupon-detail-row">
 <div class="coupon-detail-label">ประเภทจำนวน:</div>
 <div class="coupon-detail-value">${coupon.isLimited ? 'จำกัดจำนวน' : 'ไม่จำกัดจำนวน'}</div>
 </div>
 </div>
 `;

            $('couponContent').innerHTML = html;
            $('couponModal').style.display = 'flex';
        } catch (err) {
            console.error('Error loading coupon detail:', err);
            alert('ไม่สามารถโหลดรายละเอียดคูปองได้: ' + err.message);
        }
    }

    // ฟังก์ชันแสดง Confirmation Dialog
    function showConfirmDialog(message, onConfirm) {
        $('confirmMessage').innerHTML = message;
        $('confirmModal').style.display = 'flex';

        // Remove old event listeners
        const btnYes = $('confirmYes');
        const btnNo = $('confirmNo');
        const newBtnYes = btnYes.cloneNode(true);
        const newBtnNo = btnNo.cloneNode(true);
        btnYes.parentNode.replaceChild(newBtnYes, btnYes);
        btnNo.parentNode.replaceChild(newBtnNo, btnNo);

        // Add new event listeners
        newBtnYes.addEventListener('click', () => {
            $('confirmModal').style.display = 'none';
            onConfirm();
        });

        newBtnNo.addEventListener('click', () => {
            $('confirmModal').style.display = 'none';
        });
    }

    // ฟังก์ชันตัดคูปอง พร้อม Confirmation Dialog
    async function redeemCouponFromItem(receiptId, couponCode, couponName, generatedCodes, isComplimentaryChecked = false) {
        console.log('redeemCouponFromItem called', {
            receiptId,
            couponCode,
            couponName,
            generatedCodes,
            isComplimentaryChecked
        });
        try {
            // ตรวจสอบว่ามีคูปองที่ยังไม่ถูกใช้หรือไม่
            if (!generatedCodes || generatedCodes.length === 0) {
                alert('ไม่มีรหัสคูปองที่ยังไม่ถูกใช้');
                return;
            }

            // หา code ที่ยังไม่ถูกใช้
            let codeToRedeem = null;
            for (const code of generatedCodes) {
                try {
                    const resp = await fetch(`/api/GeneratedCoupons/bycode/${encodeURIComponent(code)}`);
                    if (resp.ok) {
                        const coupon = await resp.json();
                        if (!coupon.isUsed) {
                            codeToRedeem = code;
                            break;
                        }
                    }
                } catch (err) {
                    console.error('Error checking code:', code, err);
                }
            }

            if (!codeToRedeem) {
                alert('ไม่มีรหัสคูปองที่ยังไม่ถูกใช้');
                return;
            }

            // If user checked COM checkbox, mark selected generated code as complimentary before redeem
            if (isComplimentaryChecked) {
                try {
                    const respMark = await fetch('/api/GeneratedCoupons/mark-complimentary/' + encodeURIComponent(codeToRedeem), {
                        method: 'POST'
                    });
                    if (!respMark.ok) {
                        console.warn('Mark complimentary failed for', codeToRedeem, respMark.status);
                    } else {
                        console.log('Marked complimentary for', codeToRedeem);
                    }
                } catch (ex) {
                    console.error('Error marking complimentary:', ex);
                }
            }

            // แสดง Confirmation Dialog
            const message = `

 <p>คุณต้องการตัดคูปองนี้ใช่หรือไม่?</p>
 <p style="margin-top:10px;">
 <strong>คูปอง:</strong> ${escapeHtml(couponName)}<br>
 <strong>รหัสคูปอง:</strong> <span class="coupon-code-highlight">${escapeHtml(codeToRedeem)}</span><br>
 </p>
 <p style="margin-top:10px; color:#dc3545; font-size:13px;">
 ⚠️ หลังจากตัดคูปองแล้วจะไม่สามารถยกเลิกได้
 </p>
 `;

            showConfirmDialog(message, async () => {
                // ส่ง request ไปยัง API
                console.log('Redeeming coupon:', codeToRedeem);

                try {
                    // build naive local datetime string (YYYY-MM-DDTHH:mm:ss) to send as client-local time
                    const pad = (n) => String(n).padStart(2, '0');
                    const nowLocal = new Date();
                    const redeemedAtLocal = `${nowLocal.getFullYear()}-${pad(nowLocal.getMonth() + 1)}-${pad(nowLocal.getDate())}T${pad(nowLocal.getHours())}:${pad(nowLocal.getMinutes())}:${pad(nowLocal.getSeconds())}`;

                    const response = await fetch('/api/CouponRedemption/redeem', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            code: codeToRedeem,
                            redeemedBy: currentUser,
                            receiptItemId: null,
                            // send naive local time (no timezone) so server stores machine-local time
                            redeemedAt: redeemedAtLocal
                        })
                    });

                    // Safely parse JSON only if response has content
                    let result = null;
                    try {
                        const text = await response.text();
                        result = text ? JSON.parse(text) : null;
                    } catch (parseErr) {
                        console.warn('Redeem response not JSON or empty:', parseErr);
                        result = null;
                    }
                    console.log('Redeem result:', result);

                    if (response.ok && result && result.result === 'Success') {
                        // prefer server-provided local formatted string, then raw, then fallback to result.usedDate
                        const displayTime = result.usedDateLocal || result.usedDateRaw || result.usedDate || '';
                        alert(`✓ ตัดคูปองสำเร็จ!\n\nรหัสคูปอง: ${codeToRedeem}\nตัดโดย: ${result.usedBy}\nเวลา: ${formatDate(displayTime)}`);

                        // Reload receipt detail เพื่ออัพเดทข้อมูล
                        if (currentReceiptId) {
                            await showDetail(currentReceiptId);
                        }
                    } else {
                        // แสดง error message
                        let errorMsg = 'ไม่สามารถตัดคูปองได้';
                        if (result && result.result === 'NotFound') {
                            errorMsg = 'ไม่พบรหัสคูปองนี้';
                        } else if (result && result.result === 'Expired') {
                            errorMsg = 'คูปองหมดอายุแล้ว';
                        } else if (result && result.result === 'AlreadyUsed') {
                            errorMsg = 'คูปองถูกใช้ไปแล้ว';
                        } else if (result && result.message) {
                            errorMsg = result.message;
                        }
                        alert('❌ ' + errorMsg);
                    }
                } catch (err) {
                    console.error('Error redeeming coupon:', err);
                    alert('เกิดข้อผิดพลาด: ' + err.message);
                }
            });

        } catch (err) {
            console.error('Error in redeemCouponFromItem:', err);
            alert('เกิดข้อผิดพลาด: ' + err.message);
        }
    }

    function renderReceipts(data) {
        resultsBody.innerHTML = '';

        if (!data || !Array.isArray(data.items)) {
            summaryEl.textContent = 'ไม่พบข้อมูล';
            pageInfo.textContent = '';
            currentData = [];
            return;
        }

        currentData = data.items;

        data.items.forEach((item, idx) => {


            const tr = document.createElement('tr');
            const isCancelled = item.status === 'Cancelled';
            const statusClass = item.status === 'Active' ? 'status-active' : 'status-cancelled';

            if (isCancelled) {
                tr.classList.add('cancelled-row');
            }

            // read UnredeemedSummary (handle PascalCase or camelCase) and render as plain text
            const unredeemedRaw = (item.unredeemedSummary || item.UnredeemedSummary || '').trim();
            const unredeemedEsc = escapeHtml(unredeemedRaw);

            tr.innerHTML = `
 <td class="col-code">${escapeHtml(item.receiptCode || item.ReceiptCode)}</td>
 <td class="col-date">${formatDate(item.receiptDate || item.ReceiptDate)}</td>
 <td class="col-customer">${escapeHtml(item.customerName || item.CustomerName)}</td>
 <td class="col-phone">${escapeHtml(item.customerPhoneNumber || item.CustomerPhoneNumber)}</td>
 <td class="col-sales">${escapeHtml(item.salesPersonName || item.SalesPersonName || '-')}</td>
 <td class="col-payment">${escapeHtml(item.paymentMethodName || item.PaymentMethodName || '-')}</td>
 <td class="col-discount">${formatCurrency(item.discount || item.Discount)}</td>
 <td class="col-total">${formatCurrency(item.totalAmount || item.TotalAmount)}</td>
 <td class="col-status"><span class="${statusClass}">${escapeHtml(item.statusText || item.StatusText || (item.status || item.Status))}</span></td>
 <td class="col-unredeemed"><span class="unredeemed-text">${unredeemedEsc}</span></td>
 <td class="col-detail"><button class="detail-btn" data-id="${item.receiptID || item.ReceiptID}">ดูรายละเอียด</button></td>
 `;
            resultsBody.appendChild(tr);
        });

        // Attach detail button events
        document.querySelectorAll('.detail-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const receiptId = parseInt(btn.dataset.id, 10);
                showDetail(receiptId);
            });
        });

        const total = data.totalCount ?? 0;
        const totalSum = data.items.reduce((sum, item) => sum + (item.totalAmount || item.TotalAmount || 0), 0);
        summaryEl.textContent = `ผลลัพธ์ ${total.toLocaleString('th-TH')} รายการ | ยอดรวมทั้งหมด: ${formatCurrency(totalSum)} บาท`;

        page = data.page || 1;
        totalPages = data.totalPages || 1;
        pageInfo.textContent = `หน้า ${page} จาก ${totalPages}`;
        $('prev').disabled = page <= 1;
        $('next').disabled = page >= totalPages;
    }

    function escapeHtml(s) {
        if (s == null || s === undefined) return '';
        return String(s).replace(/[&<>"]'/g, c => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": "&#39;"
        }[c]));
    }

    // Events
    $('btnSearch').addEventListener('click', () => {
        page = 1;
        loadReceipts();
    });
    $('searchReceiptCode').addEventListener('input', () => {
        page = 1;
        loadReceipts();
    });
    $('searchCouponCode').addEventListener('input', () => {
        page = 1;
        loadReceipts();
    });
    $('searchCustomerName').addEventListener('input', () => {
        page = 1;
        loadReceipts();
    });
    $('searchPhone').addEventListener('input', () => {
        page = 1;
        loadReceipts();
    });
    $('searchStatus').addEventListener('change', () => {
        page = 1;
        loadReceipts();
    });
    $('dateFrom').addEventListener('change', () => {
        page = 1;
        loadReceipts();
    });
    $('dateTo').addEventListener('change', () => {
        page = 1;
        loadReceipts();
    });
    $('pageSize').addEventListener('change', () => {
        page = 1;
        loadReceipts();
    });
    $('prev').addEventListener('click', () => {
        if (page > 1) {
            page--;
            loadReceipts();
        }
    });
    $('next').addEventListener('click', () => {
        if (page < totalPages) {
            page++;
            loadReceipts();
        }
    });

    // Detail modal
    $('detailClose').addEventListener('click', () => {
        $('detailModal').style.display = 'none';
        // Refresh the main receipts table when the detail modal is closed
        loadReceipts().catch(err => console.error('Error reloading receipts after closing detail modal:', err));
    });

    // Coupon modal
    $('couponClose').addEventListener('click', () => {
        $('couponModal').style.display = 'none';
    });

    // --- New export functionality: only modal handlers ---
    let _exportType = 'excel'; // 'excel' or 'pdf'
    $('btnTodayReport').addEventListener('click', () => { openExportDialog('excel'); });
    $('btnTodayPdf').addEventListener('click', () => { openExportDialog('pdf'); });
    $('exportCancel').addEventListener('click', () => { $('exportModal').style.display = 'none'; });
    $('exportConfirm').addEventListener('click', () => { confirmExport(); });

    // Validate date range: start must not be after end
    function validateExportDates() {
 const fromVal = $('exportDateFrom').value;
 const toVal = $('exportDateTo').value;
 const errEl = $('exportError');
 const confirmBtn = $('exportConfirm');

 if (!fromVal || !toVal) {
 errEl.style.display = 'none';
 confirmBtn.disabled = false;
 return true;
 }

 try {
 const f = fromVal.split('-').map(Number);
 const t = toVal.split('-').map(Number);
 const fromLocal = new Date(f[0], f[1] -1, f[2]);
 const toLocal = new Date(t[0], t[1] -1, t[2]);
 if (fromLocal.getTime() > toLocal.getTime()) {
 errEl.textContent = 'วันที่เริ่มต้นต้องไม่เกินวันที่สิ้นสุด';
 errEl.style.display = 'block';
 confirmBtn.disabled = true;
 return false;
 }
 // valid
 errEl.style.display = 'none';
 confirmBtn.disabled = false;
 return true;
 } catch (ex) {
 errEl.textContent = 'รูปแบบวันที่ไม่ถูกต้อง';
 errEl.style.display = 'block';
 confirmBtn.disabled = true;
 return false;
 }
}

function openExportDialog(type) {
 _exportType = type === 'pdf' ? 'pdf' : 'excel';
 // default to today
 const today = new Date();
 const isoDate = today.toISOString().slice(0,10); // yyyy-mm-dd
 $('exportDateFrom').value = isoDate;
 $('exportDateTo').value = isoDate;
 // attach change handlers to validate
 $('exportDateFrom').addEventListener('change', validateExportDates);
 $('exportDateTo').addEventListener('change', validateExportDates);
 // initial validation
 validateExportDates();
 $('exportModal').style.display = 'flex';
}

function confirmExport() {
 if (!validateExportDates()) {
 return; // invalid range
 }

 const fromVal = $('exportDateFrom').value;
 const toVal = $('exportDateTo').value;
 if (!fromVal || !toVal) { alert('กรุณาเลือกทั้งวันที่เริ่มและวันที่สิ้นสุด'); return; }
 try {
 const partsF = fromVal.split('-').map(Number);
 const partsT = toVal.split('-').map(Number);
 const fromLocal = new Date(partsF[0], partsF[1] -1, partsF[2],0,0,0,0);
 const toLocal = new Date(partsT[0], partsT[1] -1, partsT[2],23,59,59,999);
 const params = new URLSearchParams();
 params.append('createdFrom', fromLocal.toISOString());
 params.append('createdTo', toLocal.toISOString());

 // Always export both detailed and summary data
 params.append('reportMode', 'both');
 params.append('includeRetrievedDate', 'true');

 const url = _exportType === 'pdf' ? '/api/CouponRedemption/export/pdf?' + params.toString() : '/api/CouponRedemption/export/excel?' + params.toString();
 // close modal then navigate
 $('exportModal').style.display = 'none';
 window.location.href = url;
 } catch (err) { console.error('Error preparing export params', err); alert('ไม่สามารถเตรียมพารามิเตอร์สำหรับการดาวน์โหลดได้'); }
}

// Initialize
    console.log('Initializing receipts page...');
    loadReceipts().catch(err => {
        console.error('Initialization error:', err);
        errorEl.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + err.message;
    });
    </script>
</body>

</html>