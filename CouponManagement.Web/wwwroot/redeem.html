<!doctype html>
<html>
<head>
 <meta charset="utf-8" />
 <title>Redeem & Sold Coupons</title>
 <style>
 body { font-family: 'Sarabun', Arial, Helvetica, sans-serif; margin:0; padding:0; background:#f5f5f5; }
 .page-header { background:#fff; padding:16px 24px; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-bottom:20px; position:relative; }
 #logoutBtn { background:#dc3545; color:white; border:none; padding:8px 16px; font-size:14px; cursor:pointer; border-radius:4px; position:absolute; top:16px; left:24px; }
 #logoutBtn:hover { background:#c82333; }
 h1 { margin:0 0 0 120px; font-size:24px; color:#333; }
 
 .panel { background:#fff; margin:0 24px 24px 24px; padding:20px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
 .header-section { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #e9ecef; }
 .header-section h2 { margin:0; font-size:20px; color:#495057; }
 .top-actions { display:flex; align-items:center; gap:12px; }
 
 .search-section { background:#f8f9fa; padding:15px; border-radius:6px; margin-bottom:20px; }
 .search-row { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
 .search-field { display:flex; flex-direction:column; }
 .search-field label { font-size:13px; color:#495057; margin-bottom:4px; font-weight:500; }
 .search-field input[type="text"], .search-field input[type="date"], .search-field select { padding:8px 12px; font-size:14px; border:1px solid #ced4da; border-radius:4px; min-width:200px; }
 .search-field input[type="text"]:focus, .search-field input[type="date"]:focus, .search-field select:focus { outline:none; border-color:#007bff; box-shadow:0 0 0 0.2rem rgba(0,123,255,0.25); }
 .search-field.small { min-width:120px; }
 .search-field.small select, .search-field.small input { min-width:100px; }
 
 .filter-mode { display:flex; align-items:center; gap:20px; margin-bottom:15px; padding:10px; background:#fff; border-radius:4px; }
 .filter-mode label { display:flex; align-items:center; gap:6px; cursor:pointer; font-size:14px; color:#495057; }
 .filter-mode input[type="radio"] { cursor:pointer; }
 .filter-mode strong { margin-right:10px; color:#212529; }
 
 button { padding:10px 20px; font-size:14px; font-weight:600; cursor:pointer; border-radius:6px; border:1px solid transparent; transition:all 0.2s; }
 button:hover:not(:disabled) { transform:translateY(-1px); box-shadow:0 2px 4px rgba(0,0,0,0.2); }
 button:disabled { opacity:0.5; cursor:not-allowed; }
 
 #redeemSelected { background:#28a745; color:white; border:none; font-size:16px; padding:10px 24px; }
 #redeemSelected:hover:not(:disabled) { background:#218838; }
 #btnSearch { background:#007bff; color:white; border:none; padding:8px 20px; }
 #btnSearch:hover { background:#0056b3; }
 #btnClearDate { background:#6c757d; color:white; border:none; padding:8px 16px; margin-left:8px; }
 #btnClearDate:hover { background:#5a6268; }
 #btnTodayReport { background:#17a2b8; color:white; border:none; font-size:14px; padding:8px 16px; }
 #btnTodayReport:hover { background:#138496; }
 #btnExportExcel { background:#28a745; color:white; border:none; font-size:14px; padding:8px 16px; }
 #btnExportExcel:hover { background:#218838; }
 #btnExportPdf { background:#dc3545; color:white; border:none; font-size:14px; padding:8px 16px; }
 #btnExportPdf:hover { background:#c82333; }
 
 table { border-collapse:collapse; width:100%; margin-top:15px; background:#fff; font-size:13px; }
 th, td { border:1px solid #dee2e6; padding:8px 10px; text-align:center; }
 th { background:#f8f9fa; font-weight:600; color:#495057; white-space:nowrap; }
 tbody tr:hover { background:#f8f9fa; }
 
 .detail-btn { background:#17a2b8; color:white; border:none; padding:5px 10px; font-size:12px; border-radius:4px; cursor:pointer; white-space:nowrap; }
 .detail-btn:hover { background:#138496; }
 
 .summary { font-size:13px; color:#6c757d; margin-top:10px; }
 .pager { margin-top:15px; display:flex; align-items:center; gap:12px; }
 .pager button { padding:8px 16px; font-size:14px; }
 .pager span { font-size:14px; color:#495057; }
 
 #modal, #detailModal { display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000; }
 #modal .box, #detailModal .box { background:#fff; padding:24px; border-radius:8px; max-width:500px; box-shadow:0 4px 12px rgba(0,0,0,0.3); }
 #modal h3, #detailModal h3 { margin:0 0 16px 0; color:#212529; }
 #modal button, #detailModal button { margin-right:8px; }
 .failure-list { color:#dc3545; margin-top:12px; max-height:200px; overflow:auto; background:#f8d7da; padding:12px; border-radius:4px; }
 .success-list { color:#28a745; margin-top:12px; background:#d4edda; padding:12px; border-radius:4px; }
 .warning-text { color:#856404; background:#fff3cd; padding:8px; border-radius:4px; margin-bottom:12px; }
 #error { color:#dc3545; margin-top:12px; padding:10px; background:#f8d7da; border-radius:4px; display:none; }
 #error:not(:empty) { display:block; }
 
 .detail-content { background:#f8f9fa; padding:15px; border-radius:6px; margin-top:12px; max-height:400px; overflow-y:auto; }
 .detail-row { display:flex; margin-bottom:10px; }
 .detail-label { font-weight:600; min-width:140px; color:#495057; }
 .detail-value { color:#212529; flex:1; word-wrap:break-word; white-space:pre-wrap; }
 
 /* จัดกรองคอลัมน์ตาราง */
 .col-checkbox { width:40px; text-align:center; }
 .col-code { width:120px; }
 .col-def-code { width:100px; }
 .col-def-name { width:150px; }
 .col-status { width:80px; }
 .col-usage { width:180px; }
 .col-used-by { width:100px; }
 .col-date { width:140px; }
 .col-expires { width:100px; }
 .col-detail { width:100px; text-align:center; }
 
 .expired-row { background:#ffe6e6 !important; }
 </style>
</head>
<body>
 <div class="page-header">
 <button id="logoutBtn">🚪 Logout</button>
 <h1>ตัดคูปอง และ รายการคูปอง</h1>
 </div>

 <div class="panel">
 <div class="header-section">
 <h2>รายการคูปอง</h2>
 <div class="top-actions">
 <button id="btnTodayReport">📊 รีพอร์ตวันนี้</button>
 <button id="btnExportExcel">📊 Export Excel</button>
 <button id="btnExportPdf">📄 Export PDF</button>
 <button id="redeemSelected" disabled>✂️ ตัดคูปอง</button>
 </div>
 </div>
 
 <div class="search-section">
 <!-- Filter Mode Selector -->
 <div class="filter-mode">
 <strong>รูปแบบการค้นหา:</strong>
 <label>
 <input type="radio" name="filterMode" value="text" checked> 
 พิมพ์ค้นหา (Text Input)
 </label>
 <label>
 <input type="radio" name="filterMode" value="dropdown"> 
 เลือกจากรายการ (Dropdown)
 </label>
 </div>
 
 <!-- Search Fields -->
 <div class="search-row">
 <div class="search-field">
 <label>ค้นหาด้วยรหัสคูปอง:</label>
 <input id="searchCode" type="text" placeholder="ใส่รหัสคูปอง" />
 </div>
 
 <div class="search-field" id="defCodeField">
 <label id="defCodeLabel">รหัสคำนิยาม:</label>
 <input id="defCodeText" type="text" placeholder="พิมพ์รหัสคำนิยาม" />
 <select id="defCodeDropdown" style="display:none">
 <option value="">-- ทั้งหมด --</option>
 </select>
 </div>
 
 <div class="search-field" id="defNameField">
 <label id="defNameLabel">ชื่อคำนิยาม:</label>
 <input id="defNameText" type="text" placeholder="พิมพ์ชื่อคำนิยาม" />
 <select id="defNameDropdown" style="display:none">
 <option value="">-- ทั้งหมด --</option>
 </select>
 </div>
 
 <div class="search-field small">
 <label>วันที่ขาย (จาก):</label>
 <input id="dateFrom" type="date" />
 </div>
 
 <div class="search-field small">
 <label>วันที่ขาย (ถึง):</label>
 <input id="dateTo" type="date" />
 </div>
 
 <div class="search-field small">
 <label>แสดงต่อหน้า:</label>
 <select id="pageSize">
 <option>10</option>
 <option selected>25</option>
 <option>50</option>
 <option>100</option>
 </select>
 </div>
 
 <div class="search-field" style="justify-content:flex-end; padding-top:20px;">
 <button id="btnSearch">🔍 ค้นหา</button>
 <button id="btnClearDate">🔄 ล้างวันที่</button>
 </div>
 </div>
 </div>

 <div id="summary" class="summary">-</div>
 
 <div style="overflow-x:auto">
 <table id="results">
 <thead>
 <tr>
 <th class="col-checkbox"><input type="checkbox" id="selectAll" /></th>
 <th class="col-code">รหัสคูปอง</th>
 <th class="col-def-code">รหัสคำนิยาม</th>
 <th class="col-def-name">ชื่อคำนิยาม</th>
 <th class="col-status">สถานะ</th>
 <th class="col-usage">การใช้งาน/ใบเสร็จ</th>
 <th class="col-used-by">UsedBy</th>
 <th class="col-date">UsedDate</th>
 <th class="col-date">สร้างเมื่อ</th>
 <th class="col-expires">วันหมดอายุ</th>
 <th class="col-detail">รายละเอียด</th>
 </tr>
 </thead>
 <tbody></tbody>
 </table>
 </div>

 <div class="pager">
 <button id="prev">⬅️ ย้อนกลับ</button>
 <span id="pageInfo"></span>
 <button id="next">ถัดไป ➡️</button>
 </div>

 <div id="error"></div>
 </div>

 <!-- Redeem Modal -->
 <div id="modal">
 <div class="box">
 <h3>ตัดคูปองที่เลือก</h3>
 <div id="modalWarning" class="warning-text" style="display:none"></div>
 <div id="modalPrompt" style="margin-bottom:12px; font-size:14px;">ยืนยันการตัดคูปอง</div>
 <div style="margin-top:16px">
 <button id="modalConfirm" style="background:#28a745; color:white; border:none;">✅ บันทึก</button>
 <button id="modalCancel" style="background:#6c757d; color:white; border:none;">❌ ยกเลิก</button>
 <span id="modalMsg" style="margin-left:12px; color:#28a745; font-weight:600;"></span>
 </div>
 <div id="modalFailures" class="failure-list" style="display:none"></div>
 <div id="modalSuccess" class="success-list" style="display:none"></div>
 </div>
 </div>

 <!-- Detail Modal -->
 <div id="detailModal">
 <div class="box" style="max-width:600px">
 <h3>📋 รายละเอียดคูปอง</h3>
 <div id="detailContent" class="detail-content"></div>
 <div style="margin-top:16px; text-align:right">
 <button id="detailClose" style="background:#6c757d; color:white; border:none;">ปิด</button>
 </div>
 </div>
 </div>

 <script>
 function $(id){ return document.getElementById(id); }

 const currentUser = (function(){ try{ return sessionStorage.getItem('currentUser') || ''; }catch(e){ return ''; } })();
 if(!currentUser){ try{ window.location.href = '/login.html'; }catch(e){} }

 // Logout
 $('logoutBtn').addEventListener('click', ()=>{
 if(confirm('คุณต้องการออกจากระบบหรือไม่?')){
 try{ sessionStorage.removeItem('currentUser'); }catch(e){}
 window.location.href = '/login.html';
 }
 });

 // Filter mode switching
 const filterModeRadios = document.querySelectorAll('input[name="filterMode"]');
 filterModeRadios.forEach(radio => {
 radio.addEventListener('change', (e) => {
 const isText = e.target.value === 'text';
 $('defCodeText').style.display = isText ? 'block' : 'none';
 $('defCodeDropdown').style.display = isText ? 'none' : 'block';
 $('defNameText').style.display = isText ? 'block' : 'none';
 $('defNameDropdown').style.display = isText ? 'none' : 'block';
 });
 });

 // Today Report Button
 $('btnTodayReport').addEventListener('click', ()=>{
 const today = new Date().toISOString().split('T')[0];
 $('dateFrom').value = today;
 $('dateTo').value = today;
 page = 1;
 loadSold();
 });

 // Clear Date Button
 $('btnClearDate').addEventListener('click', ()=>{
 $('dateFrom').value = '';
 $('dateTo').value = '';
 page = 1;
 loadSold();
 });

 // Export Excel Button
 $('btnExportExcel').addEventListener('click', async ()=>{
 try {
 const filters = getFilterValues();
 const params = new URLSearchParams();
 if(filters.search) params.append('searchCode',filters.search);
 if(filters.defCode) params.append('couponDefinitionCode',filters.defCode);
 if(filters.defName) params.append('couponDefinitionName',filters.defName);
 if(filters.dateFrom) params.append('createdFrom', filters.dateFrom + 'T00:00:00');
 if(filters.dateTo) params.append('createdTo', filters.dateTo + 'T23:59:59');

 const url = '/api/CouponRedemption/export/excel?' + params.toString();
 window.open(url, '_blank');
 } catch(err) {
 console.error('Error exporting Excel:', err);
 alert('เกิดข้อผิดพลาดในการส่งออก Excel: ' + err.message);
 }
 });

 // Export PDF Button
 $('btnExportPdf').addEventListener('click', async ()=>{
 try {
 const filters = getFilterValues();
 const params = new URLSearchParams();
 if(filters.search) params.append('searchCode',filters.search);
 if(filters.defCode) params.append('couponDefinitionCode',filters.defCode);
 if(filters.defName) params.append('couponDefinitionName',filters.defName);
 if(filters.dateFrom) params.append('createdFrom', filters.dateFrom + 'T00:00:00');
 if(filters.dateTo) params.append('createdTo', filters.dateTo + 'T23:59:59');

 const url = '/api/CouponRedemption/export/pdf?' + params.toString();
 window.open(url, '_blank');
 } catch(err) {
 console.error('Error exporting PDF:', err);
 alert('เกิดข้อผิดพลาดในการส่งออก PDF: ' + err.message);
 }
 });
 
 // Table & selection
 const resultsBody = document.querySelector('#results tbody');
 const summaryEl = $('summary');
 const pageInfo = $('pageInfo');
 const errorEl = $('error');
 const selectAll = $('selectAll');
 let selectedIds = new Set();
 let currentData = []; // เก็บข้อมูลปัจจุบัน
 
 selectAll.addEventListener('change', ()=>{
 const checked = selectAll.checked;
 document.querySelectorAll('input.rowSelect').forEach(cb=> {
 cb.checked = checked;
 if(checked) selectedIds.add(parseInt(cb.dataset.id,10));
 });
 if(!checked) selectedIds.clear();
 updateRedeemButton();
 });

 let page=1, totalPages=1;

 function formatDate(d){ 
 if(!d) return ''; 
 try{ 
 const dt=new Date(d); 
 if(isNaN(dt)) return d; 
 return dt.toLocaleString('th-TH', { 
 year: 'numeric', 
 month: '2-digit', 
 day: '2-digit',
 hour: '2-digit',
 minute: '2-digit'
 }); 
 }catch{ return d; } 
 }
 
 function formatDateOnly(d){
 if(!d) return '';
 try{
 const dt=new Date(d);
 if(isNaN(dt)) return d;
 return dt.toLocaleDateString('th-TH', {
 year: 'numeric',
 month: '2-digit',
 day: '2-digit'
 });
 }catch{ return d; }
 }

 function isExpired(expiresAt){
 if(!expiresAt) return false;
 try{
 const expDate = new Date(expiresAt);
 const now = new Date();
 return expDate < now;
 }catch{
 return false;
 }
 }

 function getFilterValues(){
 const isText = document.querySelector('input[name="filterMode"]:checked').value === 'text';
 return {
 search: $('searchCode').value.trim(),
 defCode: isText ? $('defCodeText').value.trim() : $('defCodeDropdown').value.trim(),
 defName: isText ? $('defNameText').value.trim() : $('defNameDropdown').value.trim(),
 dateFrom: $('dateFrom').value,
 dateTo: $('dateTo').value,
 pageSize: parseInt($('pageSize').value,10)||25
 };
 }

 async function loadCouponDefinitions(){
 try{
 const resp = await fetch('/api/CouponDefinitions');
 if(!resp.ok) {
 console.error('Failed to load definitions:', resp.status, resp.statusText);
 return;
 }
 const defs = await resp.json();
 
 console.log('Loaded coupon definitions:', defs.length);
 
 const codeSelect = $('defCodeDropdown');
 const nameSelect = $('defNameDropdown');
 
 codeSelect.innerHTML = '<option value="">-- ทั้งหมด --</option>';
 nameSelect.innerHTML = '<option value="">-- ทั้งหมด --</option>';
 
 const codes = new Set();
 const names = new Set();
 
 defs.forEach(def=>{
 if(def.code && !codes.has(def.code)){
 codes.add(def.code);
 codeSelect.add(new Option(def.code, def.code));
 }
 if(def.name && !names.has(def.name)){
 names.add(def.name);
 nameSelect.add(new Option(def.name, def.name));
 }
 });
 
 console.log('Populated dropdowns - Codes:', codes.size, 'Names:', names.size);
 }catch(err){
 console.error('Error loading coupon definitions:', err);
 errorEl.textContent = 'ไม่สามารถโหลดรายการคำนิยามได้: ' + err.message;
 }
 }

 async function loadSold(){ 
 errorEl.textContent=''; 
 const filters = getFilterValues();
 
 const params = new URLSearchParams(); 
 params.append('page',page); 
 params.append('pageSize',filters.pageSize); 
 if(filters.search) params.append('searchCode',filters.search); 
 if(filters.defCode) params.append('couponDefinitionCode',filters.defCode); 
 if(filters.defName) params.append('couponDefinitionName',filters.defName);
 if(filters.dateFrom) params.append('createdFrom', filters.dateFrom + 'T00:00:00');
 if(filters.dateTo) params.append('createdTo', filters.dateTo + 'T23:59:59');
 
 console.log('Loading sold coupons with params:', params.toString());
 
 try{ 
 const resp = await fetch('/api/CouponRedemption/sold?'+params.toString()); 
 if(!resp.ok){ 
 errorEl.textContent='HTTP '+resp.status+' - '+resp.statusText; 
 resultsBody.innerHTML=''; 
 summaryEl.textContent='-'; 
 pageInfo.textContent=''; 
 return; 
 } 
 const data=await resp.json(); 
 console.log('Loaded sold coupons:', data.items?.length || 0, 'items');
 renderSold(data); 
 }catch(err){ 
 console.error('Error loading sold coupons:', err);
 errorEl.textContent='เกิดข้อผิดพลาด: '+err.message; 
 } 
 }

 function showDetail(item){
 try{
 console.log('Showing detail for item:', item);
 
 let description = 'ไม่มีรายละเอียด';
 
 if(item.couponDefinitionParams){
 try{
 const params = JSON.parse(item.couponDefinitionParams);
 description = params.description || 'ไม่มีรายละเอียด';
 }catch(parseErr){
 console.error('Error parsing params:', parseErr);
 description = item.couponDefinitionParams;
 }
 }
 
 // จัดการขึ้นบรรทัดใหม่ใน description
 const formattedDescription = escapeHtml(description).replace(/\\n/g, '<br>').replace(/\n/g, '<br>');
 
 const expiredText = isExpired(item.expiresAt) ? ' <span style="color:#dc3545; font-weight:bold;">(หมดอายุแล้ว)</span>' : '';
 
 const html = `
 <div class="detail-row">
 <div class="detail-label">รหัสคำนิยาม:</div>
 <div class="detail-value">${escapeHtml(item.couponDefinitionCode)}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">ชื่อคำนิยาม:</div>
 <div class="detail-value">${escapeHtml(item.couponDefinitionName)}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">ราคา:</div>
 <div class="detail-value">${(item.couponDefinitionPrice || 0).toLocaleString('th-TH', {minimumFractionDigits:2, maximumFractionDigits:2})} บาท</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">รายละเอียด:</div>
 <div class="detail-value">${formattedDescription}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">รหัสคูปอง:</div>
 <div class="detail-value">${escapeHtml(item.generatedCode)}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">สถานะ:</div>
 <div class="detail-value">${escapeHtml(item.statusText)}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">การใช้งาน:</div>
 <div class="detail-value">${escapeHtml(item.usageText)}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">วันหมดอายุ:</div>
 <div class="detail-value">${item.expiresAt ? formatDateOnly(item.expiresAt) : 'ไม่มีกำหนด'}${expiredText}</div>
 </div>
 <div class="detail-row">
 <div class="detail-label">สร้างเมื่อ:</div>
 <div class="detail-value">${formatDate(item.createdAt)}</div>
 </div>
 `;
 
 $('detailContent').innerHTML = html;
 $('detailModal').style.display = 'flex';
 }catch(err){
 console.error('Error showing detail:', err);
 alert('ไม่สามารถแสดงรายละเอียดได้: ' + err.message);
 }
 }

 function renderSold(data){ 
 resultsBody.innerHTML=''; 
 selectedIds.clear(); 
 selectAll.checked=false; 
 
 if(!data || !Array.isArray(data.items)){ 
 summaryEl.textContent='ไม่พบข้อมูล'; 
 pageInfo.textContent=''; 
 currentData = [];
 return; 
 }
 
 currentData = data.items;
 
 data.items.forEach((item, idx)=>{
 const tr=document.createElement('tr');
 const id=item.id;
 const expired = isExpired(item.expiresAt);
 
 if(expired) {
 tr.classList.add('expired-row');
 }
 
 tr.innerHTML=`
 <td class="col-checkbox"><input class="rowSelect" type="checkbox" data-id="${id}" /></td>
 <td class="col-code">${escapeHtml(item.generatedCode)}</td>
 <td class="col-def-code">${escapeHtml(item.couponDefinitionCode)}</td>
 <td class="col-def-name">${escapeHtml(item.couponDefinitionName)}</td>
 <td class="col-status">${escapeHtml(item.statusText)}</td>
 <td class="col-usage">${escapeHtml(item.usageText)}</td>
 <td class="col-used-by">${escapeHtml(item.usedBy ?? '')}</td>
 <td class="col-date">${item.usedDate ? formatDate(item.usedDate) : ''}</td>
 <td class="col-date">${formatDate(item.createdAt)}</td>
 <td class="col-expires">${item.expiresAt ? formatDateOnly(item.expiresAt) : ''}${expired ? ' <span style="color:#dc3545;">⚠️</span>' : ''}</td>
 <td class="col-detail"><button class="detail-btn" data-idx="${idx}">📋 ดูรายละเอียด</button></td>
 `;
 resultsBody.appendChild(tr);
 });
 
 // Attach events
 document.querySelectorAll('input.rowSelect').forEach(cb=>{
 cb.addEventListener('change', ()=>{ 
 const id=parseInt(cb.dataset.id,10); 
 if(cb.checked) selectedIds.add(id); 
 else selectedIds.delete(id); 
 updateRedeemButton(); 
 });
 });
 
 document.querySelectorAll('.detail-btn').forEach(btn=>{
 btn.addEventListener('click', ()=>{
 const idx = parseInt(btn.dataset.idx, 10);
 if(currentData[idx]) showDetail(currentData[idx]);
 });
 });
 
 const total = data.totalCount ??0;
 summaryEl.textContent=`ผลลัพธ์ ${total.toLocaleString('th-TH')} รายการ`;
 page = data.page ||1; 
 totalPages = data.totalPages ||1; 
 pageInfo.textContent=`หน้า ${page} จาก ${totalPages}`;
 $('prev').disabled = page <=1; 
 $('next').disabled = page >= totalPages;
 updateRedeemButton(); 
 }

 function escapeHtml(s){ 
 if(s==null || s===undefined) return ''; 
 return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); 
 }

 function updateRedeemButton(){ 
 $('redeemSelected').disabled = selectedIds.size ===0; 
 }

 // Events
 $('btnSearch').addEventListener('click', ()=>{ page=1; loadSold(); });
 $('searchCode').addEventListener('input', ()=>{ page=1; loadSold(); });
 $('defCodeText').addEventListener('input', ()=>{ page=1; loadSold(); });
 $('defNameText').addEventListener('input', ()=>{ page=1; loadSold(); });
 $('defCodeDropdown').addEventListener('change', ()=>{ page=1; loadSold(); });
 $('defNameDropdown').addEventListener('change', ()=>{ page=1; loadSold(); });
 $('dateFrom').addEventListener('change', ()=>{ page=1; loadSold(); });
 $('dateTo').addEventListener('change', ()=>{ page=1; loadSold(); });
 $('pageSize').addEventListener('change', ()=>{ page=1; loadSold(); });
 $('prev').addEventListener('click', ()=>{ if(page>1){ page--; loadSold(); } });
 $('next').addEventListener('click', ()=>{ if(page<totalPages){ page++; loadSold(); } });

 // Detail modal
 $('detailClose').addEventListener('click', ()=>{ $('detailModal').style.display='none'; });

 // Redeem
 $('redeemSelected').addEventListener('click', ()=>{
 if(selectedIds.size ===0) return;
 
 // Check for expired coupons in selection
 const expiredCoupons = [];
 selectedIds.forEach(id => {
 const item = currentData.find(d => d.id === id);
 if(item && isExpired(item.expiresAt)) {
 expiredCoupons.push(item.generatedCode);
 }
 });
 
 $('modal').style.display='flex';
 $('modalMsg').textContent='';
 $('modalFailures').style.display='none';
 $('modalSuccess').style.display='none';
 $('modalFailures').innerHTML='';
 $('modalSuccess').innerHTML='';
 
 if(expiredCoupons.length > 0) {
 $('modalWarning').innerHTML = `⚠️ <strong>คำเตือน:</strong> มีคูปองหมดอายุ ${expiredCoupons.length} รายการ: ${escapeHtml(expiredCoupons.join(', '))}`;
 $('modalWarning').style.display = 'block';
 } else {
 $('modalWarning').style.display = 'none';
 }
 
 const codes = Array.from(selectedIds).map(id => {
 const cb = document.querySelector(`input.rowSelect[data-id="${id}"]`);
 const row = cb?.closest('tr');
 return row ? row.children[1].innerText.trim() : '';
 }).filter(Boolean);
 
 $('modalPrompt').textContent = codes.length ===1 
 ? `ยืนยันจะตัดบัตรใบ ${codes[0]} นี้ใช่ไหม` 
 : `ยืนยันจะตัดบัตร ${codes.length} ใบ ใช่ไหม`;
 });

 $('modalCancel').addEventListener('click', ()=>{ $('modal').style.display='none'; });
 
 $('modalConfirm').addEventListener('click', async ()=>{
 const usedBy = currentUser || 'system';
 const ids = Array.from(selectedIds);
 $('modalConfirm').disabled = true; 
 $('modalMsg').textContent='กำลังบันทึก...';
 const successes = [];
 const failures = [];
 
 try{
 for(const id of ids){
 const checkbox = document.querySelector(`input.rowSelect[data-id="${id}"]`);
 if(!checkbox) continue;
 const row = checkbox.closest('tr');
 const code = row.children[1].innerText.trim();
 
 // Check expiration before redeeming
 const item = currentData.find(d => d.id === id);
 if(item && isExpired(item.expiresAt)) {
 failures.push({ code, message: 'คูปองหมดอายุแล้ว' });
 continue;
 }
 
 try{
 const resp = await fetch('/api/CouponRedemption/redeem',{ 
 method:'POST', 
 headers:{'Content-Type':'application/json'}, 
 body: JSON.stringify({ code, redeemedBy: usedBy })
 });
 
 const body = await resp.json().catch(()=>null);
 if(resp.ok){ 
 successes.push(code); 
 } else {
 const msg = body?.message ?? body?.result ?? resp.statusText;
 failures.push({ code, message: msg });
 }
 }catch(netErr){ 
 failures.push({ code, message: 'Network error' }); 
 }
 }
 
 if(failures.length){ 
 let html = '<strong>ไม่สามารถตัดคูปองบางรายการได้:</strong><ul>'; 
 failures.forEach(f=> html += `<li>${escapeHtml(f.code)}: ${escapeHtml(f.message)}</li>`); 
 html += '</ul>'; 
 $('modalFailures').innerHTML = html; 
 $('modalFailures').style.display = 'block'; 
 }
 
 if(successes.length){ 
 $('modalSuccess').innerHTML = `<strong>✅ ตัดคูปองสำเร็จ:</strong> ${escapeHtml(successes.join(', '))}`; 
 $('modalSuccess').style.display = 'block';
 await loadSold();
 
 successes.forEach(c=>{
 const row = Array.from(document.querySelectorAll('#results tbody tr'))
 .find(r => r.children[1].innerText.trim() === c);
 if(row){ 
 const cb = row.querySelector('input.rowSelect'); 
 if(cb) cb.checked = false; 
 const idAttr = cb?.dataset.id; 
 if(idAttr) selectedIds.delete(parseInt(idAttr,10)); 
 }
 });
 updateRedeemButton(); 
 }
 
 $('modalMsg').textContent = successes.length ? 'บันทึกเรียบร้อย' : 'ไม่สามารถบันทึกได้';
 
 if(successes.length && failures.length === 0){ 
 setTimeout(()=>{ 
 $('modal').style.display='none'; 
 $('modalMsg').textContent=''; 
 $('modalFailures').style.display='none'; 
 $('modalSuccess').style.display='none'; 
 $('modalWarning').style.display='none';
 },2000); 
 }
 
 $('modalConfirm').disabled = false;
 }catch(err){ 
 $('modalMsg').textContent='เกิดข้อผิดพลาด: '+err; 
 $('modalConfirm').disabled=false; 
 }
 });

 // Initialize
 console.log('Initializing page...');
 loadCouponDefinitions().then(()=> {
 console.log('Coupon definitions loaded, loading sold coupons...');
 return loadSold();
 }).catch(err => {
 console.error('Initialization error:', err);
 errorEl.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + err.message;
 });
 </script>
</body>
</html>