<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Login</title>
<style>
 html,body{height:100%;margin:0}
 body { font-family: Arial, Helvetica, sans-serif; background:#f2f2f2; display:flex; align-items:center; justify-content:center; }
 .card { width:360px; padding:20px; background:#fff; border-radius:6px; box-shadow:0,2px,6px rgba(0,0,0,.15); }
 .card h2{ margin:0,0,12px,0; text-align:center }
 label{ display:block; margin:8px,0,4px,0 }
 input[type=text],input[type=password]{ width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box }
 button{ margin-top:12px; padding:12px,16px; background:#0078d4; color:#fff; border:none; border-radius:6px; width:100%; font-size:16px; cursor:pointer }
 button:active{ transform:translateY(1px) }
 .error{ color:#b00020; margin-top:8px; white-space:pre-wrap }
</style>
</head>
<body>
 <div class="card">
 <h2>เข้าสู่ระบบ</h2>
 <form id="loginForm">
 <label for="username">ชื่อผู้ใช้</label>
 <input id="username" name="username" type="text" />
 <label for="password">รหัสผ่าน</label>
 <input id="password" name="password" type="password" />
 <button type="submit">เข้าสู่ระบบ</button>
 <div id="error" class="error" role="alert" aria-live="polite"></div>
 </form>
 </div>
 <script>
 const errorEl = document.getElementById('error');
 document.getElementById('loginForm').addEventListener('submit', async function(e){
 e.preventDefault();
 errorEl.textContent = '';
 const u = document.getElementById('username').value.trim();
 const p = document.getElementById('password').value.trim();

 if(!u || !p){
 errorEl.textContent = 'กรุณากรอกชื่อผู้ใช้และรหัสผ่านให้ครบถ้วน';
 return;
 }

 try{
 const fd = new FormData(); fd.append('username', u); fd.append('password', p);
 const res = await fetch('/api/auth/login',{method:'POST', body: fd});
 if(res.ok){
 // store current user for redeem page in sessionStorage so it is cleared when browser is closed
 try{ sessionStorage.setItem('currentUser', u); }catch(e){ /* ignore storage errors */ }
 window.location.href = '/redeem.html';
 return;
 }

 // Handle known status codes with friendly Thai messages
 if(res.status ===400){
 // Try to parse JSON problem details or validation errors
 try{
 const j = await res.json();
 if(j && j.errors){
 // join validation messages
 const msgs = [];
 for(const k in j.errors){
 if(Array.isArray(j.errors[k])) msgs.push(...j.errors[k]);
 else msgs.push(j.errors[k]);
 }
 errorEl.textContent = msgs.join('\n') || 'ข้อมูลไม่ถูกต้อง กรุณาตรวจสอบ';
 } else if(j && j.title){
 errorEl.textContent = j.title;
 } else {
 const txt = await res.text();
 errorEl.textContent = txt || 'ข้อมูลไม่ถูกต้อง';
 }
 } catch (ex){
 const txt = await res.text();
 errorEl.textContent = txt || 'ข้อมูลไม่ถูกต้อง';
 }
 return;
 }

 if(res.status ===401){
 errorEl.textContent = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
 return;
 }

 // Fallback: show text or generic message
 const txt = await res.text();
 errorEl.textContent = txt || 'ไม่สามารถเข้าสู่ระบบได้ กรุณาลองใหม่ภายหลัง';
 } catch(err){
 console.error(err);
 errorEl.textContent = 'เกิดข้อผิดพลาดขณะติดต่อเซิร์ฟเวอร์ กรุณาลองใหม่';
 }
 });
 </script>
</body>
</html>